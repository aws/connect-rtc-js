!function(){function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){return e(b[g][1][a]||a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}return a}()({1:[function(a,b,c){"use strict";var d={};d.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},d.localCName=d.generateIdentifier(),d.splitLines=function(a){return a.trim().split("\n").map(function(a){return a.trim()})},d.splitSections=function(a){return a.split("\nm=").map(function(a,b){return(b>0?"m="+a:a).trim()+"\r\n"})},d.matchPrefix=function(a,b){return d.splitLines(a).filter(function(a){return 0===a.indexOf(b)})},d.parseCandidate=function(a){var b;b=0===a.indexOf("a=candidate:")?a.substring(12).split(" "):a.substring(10).split(" ");for(var c={foundation:b[0],component:b[1],protocol:b[2].toLowerCase(),priority:parseInt(b[3],10),ip:b[4],port:parseInt(b[5],10),type:b[7]},d=8;d<b.length;d+=2)switch(b[d]){case"raddr":c.relatedAddress=b[d+1];break;case"rport":c.relatedPort=parseInt(b[d+1],10);break;case"tcptype":c.tcpType=b[d+1];break;default:c[b[d]]=b[d+1]}return c},d.writeCandidate=function(a){var b=[];b.push(a.foundation),b.push(a.component),b.push(a.protocol.toUpperCase()),b.push(a.priority),b.push(a.ip),b.push(a.port);var c=a.type;return b.push("typ"),b.push(c),"host"!==c&&a.relatedAddress&&a.relatedPort&&(b.push("raddr"),b.push(a.relatedAddress),b.push("rport"),b.push(a.relatedPort)),a.tcpType&&"tcp"===a.protocol.toLowerCase()&&(b.push("tcptype"),b.push(a.tcpType)),"candidate:"+b.join(" ")},d.parseIceOptions=function(a){return a.substr(14).split(" ")},d.parseRtpMap=function(a){var b=a.substr(9).split(" "),c={payloadType:parseInt(b.shift(),10)};return b=b[0].split("/"),c.name=b[0],c.clockRate=parseInt(b[1],10),c.numChannels=3===b.length?parseInt(b[2],10):1,c},d.writeRtpMap=function(a){var b=a.payloadType;return void 0!==a.preferredPayloadType&&(b=a.preferredPayloadType),"a=rtpmap:"+b+" "+a.name+"/"+a.clockRate+(1!==a.numChannels?"/"+a.numChannels:"")+"\r\n"},d.parseExtmap=function(a){var b=a.substr(9).split(" ");return{id:parseInt(b[0],10),direction:b[0].indexOf("/")>0?b[0].split("/")[1]:"sendrecv",uri:b[1]}},d.writeExtmap=function(a){return"a=extmap:"+(a.id||a.preferredId)+(a.direction&&"sendrecv"!==a.direction?"/"+a.direction:"")+" "+a.uri+"\r\n"},d.parseFmtp=function(a){for(var b,c={},d=a.substr(a.indexOf(" ")+1).split(";"),e=0;e<d.length;e++)b=d[e].trim().split("="),c[b[0].trim()]=b[1];return c},d.writeFmtp=function(a){var b="",c=a.payloadType;if(void 0!==a.preferredPayloadType&&(c=a.preferredPayloadType),a.parameters&&Object.keys(a.parameters).length){var d=[];Object.keys(a.parameters).forEach(function(b){d.push(b+"="+a.parameters[b])}),b+="a=fmtp:"+c+" "+d.join(";")+"\r\n"}return b},d.parseRtcpFb=function(a){var b=a.substr(a.indexOf(" ")+1).split(" ");return{type:b.shift(),parameter:b.join(" ")}},d.writeRtcpFb=function(a){var b="",c=a.payloadType;return void 0!==a.preferredPayloadType&&(c=a.preferredPayloadType),a.rtcpFeedback&&a.rtcpFeedback.length&&a.rtcpFeedback.forEach(function(a){b+="a=rtcp-fb:"+c+" "+a.type+(a.parameter&&a.parameter.length?" "+a.parameter:"")+"\r\n"}),b},d.parseSsrcMedia=function(a){var b=a.indexOf(" "),c={ssrc:parseInt(a.substr(7,b-7),10)},d=a.indexOf(":",b);return d>-1?(c.attribute=a.substr(b+1,d-b-1),c.value=a.substr(d+1)):c.attribute=a.substr(b+1),c},d.getMid=function(a){var b=d.matchPrefix(a,"a=mid:")[0];if(b)return b.substr(6)},d.parseFingerprint=function(a){var b=a.substr(14).split(" ");return{algorithm:b[0].toLowerCase(),value:b[1]}},d.getDtlsParameters=function(a,b){return{role:"auto",fingerprints:d.matchPrefix(a+b,"a=fingerprint:").map(d.parseFingerprint)}},d.writeDtlsParameters=function(a,b){var c="a=setup:"+b+"\r\n";return a.fingerprints.forEach(function(a){c+="a=fingerprint:"+a.algorithm+" "+a.value+"\r\n"}),c},d.getIceParameters=function(a,b){var c=d.splitLines(a);return c=c.concat(d.splitLines(b)),{usernameFragment:c.filter(function(a){return 0===a.indexOf("a=ice-ufrag:")})[0].substr(12),password:c.filter(function(a){return 0===a.indexOf("a=ice-pwd:")})[0].substr(10)}},d.writeIceParameters=function(a){return"a=ice-ufrag:"+a.usernameFragment+"\r\na=ice-pwd:"+a.password+"\r\n"},d.parseRtpParameters=function(a){for(var b={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},c=d.splitLines(a),e=c[0].split(" "),f=3;f<e.length;f++){var g=e[f],h=d.matchPrefix(a,"a=rtpmap:"+g+" ")[0];if(h){var i=d.parseRtpMap(h),j=d.matchPrefix(a,"a=fmtp:"+g+" ");switch(i.parameters=j.length?d.parseFmtp(j[0]):{},i.rtcpFeedback=d.matchPrefix(a,"a=rtcp-fb:"+g+" ").map(d.parseRtcpFb),b.codecs.push(i),i.name.toUpperCase()){case"RED":case"ULPFEC":b.fecMechanisms.push(i.name.toUpperCase())}}}return d.matchPrefix(a,"a=extmap:").forEach(function(a){b.headerExtensions.push(d.parseExtmap(a))}),b},d.writeRtpDescription=function(a,b){var c="";c+="m="+a+" ",c+=b.codecs.length>0?"9":"0",c+=" UDP/TLS/RTP/SAVPF ",c+=b.codecs.map(function(a){return void 0!==a.preferredPayloadType?a.preferredPayloadType:a.payloadType}).join(" ")+"\r\n",c+="c=IN IP4 0.0.0.0\r\n",c+="a=rtcp:9 IN IP4 0.0.0.0\r\n",b.codecs.forEach(function(a){c+=d.writeRtpMap(a),c+=d.writeFmtp(a),c+=d.writeRtcpFb(a)});var e=0;return b.codecs.forEach(function(a){a.maxptime>e&&(e=a.maxptime)}),e>0&&(c+="a=maxptime:"+e+"\r\n"),c+="a=rtcp-mux\r\n",b.headerExtensions.forEach(function(a){c+=d.writeExtmap(a)}),c},d.parseRtpEncodingParameters=function(a){var b,c=[],e=d.parseRtpParameters(a),f=-1!==e.fecMechanisms.indexOf("RED"),g=-1!==e.fecMechanisms.indexOf("ULPFEC"),h=d.matchPrefix(a,"a=ssrc:").map(function(a){return d.parseSsrcMedia(a)}).filter(function(a){return"cname"===a.attribute}),i=h.length>0&&h[0].ssrc,j=d.matchPrefix(a,"a=ssrc-group:FID").map(function(a){var b=a.split(" ");return b.shift(),b.map(function(a){return parseInt(a,10)})});j.length>0&&j[0].length>1&&j[0][0]===i&&(b=j[0][1]),e.codecs.forEach(function(a){if("RTX"===a.name.toUpperCase()&&a.parameters.apt){var d={ssrc:i,codecPayloadType:parseInt(a.parameters.apt,10),rtx:{ssrc:b}};c.push(d),f&&(d=JSON.parse(JSON.stringify(d)),d.fec={ssrc:b,mechanism:g?"red+ulpfec":"red"},c.push(d))}}),0===c.length&&i&&c.push({ssrc:i});var k=d.matchPrefix(a,"b=");return k.length&&(0===k[0].indexOf("b=TIAS:")?k=parseInt(k[0].substr(7),10):0===k[0].indexOf("b=AS:")&&(k=parseInt(k[0].substr(5),10)),c.forEach(function(a){a.maxBitrate=k})),c},d.parseRtcpParameters=function(a){var b={},c=d.matchPrefix(a,"a=ssrc:").map(function(a){return d.parseSsrcMedia(a)}).filter(function(a){return"cname"===a.attribute})[0];c&&(b.cname=c.value,b.ssrc=c.ssrc);var e=d.matchPrefix(a,"a=rtcp-rsize");b.reducedSize=e.length>0,b.compound=0===e.length;var f=d.matchPrefix(a,"a=rtcp-mux");return b.mux=f.length>0,b},d.parseMsid=function(a){var b,c=d.matchPrefix(a,"a=msid:");if(1===c.length)return b=c[0].substr(7).split(" "),{stream:b[0],track:b[1]};var e=d.matchPrefix(a,"a=ssrc:").map(function(a){return d.parseSsrcMedia(a)}).filter(function(a){return"msid"===a.attribute});return e.length>0?(b=e[0].value.split(" "),{stream:b[0],track:b[1]}):void 0},d.writeSessionBoilerplate=function(){return"v=0\r\no=thisisadapterortc 8169639915646943137 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},d.writeMediaSection=function(a,b,c,e){var f=d.writeRtpDescription(a.kind,b);if(f+=d.writeIceParameters(a.iceGatherer.getLocalParameters()),f+=d.writeDtlsParameters(a.dtlsTransport.getLocalParameters(),"offer"===c?"actpass":"active"),f+="a=mid:"+a.mid+"\r\n",a.direction?f+="a="+a.direction+"\r\n":a.rtpSender&&a.rtpReceiver?f+="a=sendrecv\r\n":a.rtpSender?f+="a=sendonly\r\n":a.rtpReceiver?f+="a=recvonly\r\n":f+="a=inactive\r\n",a.rtpSender){var g="msid:"+e.id+" "+a.rtpSender.track.id+"\r\n";f+="a="+g,f+="a=ssrc:"+a.sendEncodingParameters[0].ssrc+" "+g,a.sendEncodingParameters[0].rtx&&(f+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" "+g,f+="a=ssrc-group:FID "+a.sendEncodingParameters[0].ssrc+" "+a.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return f+="a=ssrc:"+a.sendEncodingParameters[0].ssrc+" cname:"+d.localCName+"\r\n",a.rtpSender&&a.sendEncodingParameters[0].rtx&&(f+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" cname:"+d.localCName+"\r\n"),f},d.getDirection=function(a,b){for(var c=d.splitLines(a),e=0;e<c.length;e++)switch(c[e]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return c[e].substr(2)}return b?d.getDirection(b):"sendrecv"},d.getKind=function(a){return d.splitLines(a)[0].split(" ")[0].substr(2)},d.isRejected=function(a){return"0"===a.split(" ",2)[1]},b.exports=d},{}],2:[function(a,b,c){function d(a,b){var c=b||0,d=e;return[d[a[c++]],d[a[c++]],d[a[c++]],d[a[c++]],"-",d[a[c++]],d[a[c++]],"-",d[a[c++]],d[a[c++]],"-",d[a[c++]],d[a[c++]],"-",d[a[c++]],d[a[c++]],d[a[c++]],d[a[c++]],d[a[c++]],d[a[c++]]].join("")}for(var e=[],f=0;f<256;++f)e[f]=(f+256).toString(16).substr(1);b.exports=d},{}],3:[function(a,b,c){var d="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(d){var e=new Uint8Array(16);b.exports=function(){return d(e),e}}else{var f=new Array(16);b.exports=function(){for(var a,b=0;b<16;b++)0==(3&b)&&(a=4294967296*Math.random()),f[b]=a>>>((3&b)<<3)&255;return f}}},{}],4:[function(a,b,c){function d(a,b,c){var d=b&&c||0;"string"==typeof a&&(b="binary"===a?new Array(16):null,a=null),a=a||{};var g=a.random||(a.rng||e)();if(g[6]=15&g[6]|64,g[8]=63&g[8]|128,b)for(var h=0;h<16;++h)b[d+h]=g[h];return b||f(g)}var e=a("./lib/rng"),f=a("./lib/bytesToUuid");b.exports=d},{"./lib/bytesToUuid":2,"./lib/rng":3}],5:[function(a,b,c){"use strict";!function(){var c=a("./utils").log,d=a("./utils").browserDetails;b.exports.browserDetails=d,b.exports.extractVersion=a("./utils").extractVersion,b.exports.disableLog=a("./utils").disableLog;var e=a("./chrome/chrome_shim")||null,f=a("./edge/edge_shim")||null,g=a("./firefox/firefox_shim")||null,h=a("./safari/safari_shim")||null;switch(d.browser){case"opera":case"chrome":if(!e||!e.shimPeerConnection)return void c("Chrome shim is not included in this adapter release.");c("adapter.js shimming chrome."),b.exports.browserShim=e,e.shimGetUserMedia(),e.shimMediaStream(),e.shimSourceObject(),e.shimPeerConnection(),e.shimOnTrack();break;case"firefox":if(!g||!g.shimPeerConnection)return void c("Firefox shim is not included in this adapter release.");c("adapter.js shimming firefox."),b.exports.browserShim=g,g.shimGetUserMedia(),g.shimSourceObject(),g.shimPeerConnection(),g.shimOnTrack();break;case"edge":if(!f||!f.shimPeerConnection)return void c("MS edge shim is not included in this adapter release.");c("adapter.js shimming edge."),b.exports.browserShim=f,f.shimGetUserMedia(),f.shimPeerConnection();break;case"safari":if(!h)return void c("Safari shim is not included in this adapter release.");c("adapter.js shimming safari."),b.exports.browserShim=h,h.shimGetUserMedia();break;default:c("Unsupported browser!")}}()},{"./chrome/chrome_shim":6,"./edge/edge_shim":8,"./firefox/firefox_shim":10,"./safari/safari_shim":12,"./utils":13}],6:[function(a,b,c){"use strict";var d=a("../utils.js").log,e=a("../utils.js").browserDetails,f={shimMediaStream:function(){window.MediaStream=window.MediaStream||window.webkitMediaStream},shimOnTrack:function(){"object"!=typeof window||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(a){var b=this;this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=a),this.addEventListener("addstream",this._ontrackpoly=function(a){a.stream.addEventListener("addtrack",function(c){var d=new Event("track");d.track=c.track,d.receiver={track:c.track},d.streams=[a.stream],b.dispatchEvent(d)}),a.stream.getTracks().forEach(function(b){var c=new Event("track");c.track=b,c.receiver={track:b},c.streams=[a.stream],this.dispatchEvent(c)}.bind(this))}.bind(this))}})},shimSourceObject:function(){"object"==typeof window&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(a){var b=this;if(this._srcObject=a,this.src&&URL.revokeObjectURL(this.src),!a)return void(this.src="");this.src=URL.createObjectURL(a),a.addEventListener("addtrack",function(){b.src&&URL.revokeObjectURL(b.src),b.src=URL.createObjectURL(a)}),a.addEventListener("removetrack",function(){b.src&&URL.revokeObjectURL(b.src),b.src=URL.createObjectURL(a)})}}))},shimPeerConnection:function(){window.RTCPeerConnection=function(a,b){d("PeerConnection"),a&&a.iceTransportPolicy&&(a.iceTransports=a.iceTransportPolicy);var c=new webkitRTCPeerConnection(a,b),e=c.getStats.bind(c);return c.getStats=function(a,b,c){var d=this,f=arguments;if(arguments.length>0&&"function"==typeof a)return e(a,b);var g=function(a){var b={};return a.result().forEach(function(a){var c={id:a.id,timestamp:a.timestamp,type:a.type};a.names().forEach(function(b){c[b]=a.stat(b)}),b[c.id]=c}),b},h=function(a,b){var c=new Map(Object.keys(a).map(function(b){return[b,a[b]]}));return b=b||a,Object.keys(b).forEach(function(a){c[a]=b[a]}),c};if(arguments.length>=2){var i=function(a){f[1](h(g(a)))};return e.apply(this,[i,arguments[0]])}return new Promise(function(b,c){1===f.length&&"object"==typeof a?e.apply(d,[function(a){b(h(g(a)))},c]):e.apply(d,[function(a){b(h(g(a),a.result()))},c])}).then(b,c)},c},window.RTCPeerConnection.prototype=webkitRTCPeerConnection.prototype,webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return webkitRTCPeerConnection.generateCertificate}}),["createOffer","createAnswer"].forEach(function(a){var b=webkitRTCPeerConnection.prototype[a];webkitRTCPeerConnection.prototype[a]=function(){var a=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var c=1===arguments.length?arguments[0]:void 0;return new Promise(function(d,e){b.apply(a,[d,e,c])})}return b.apply(this,arguments)}}),e.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(a){var b=webkitRTCPeerConnection.prototype[a];webkitRTCPeerConnection.prototype[a]=function(){var a=arguments,c=this,d=new Promise(function(d,e){b.apply(c,[a[0],d,e])});return a.length<2?d:d.then(function(){a[1].apply(null,[])},function(b){a.length>=3&&a[2].apply(null,[b])})}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(a){var b=webkitRTCPeerConnection.prototype[a];webkitRTCPeerConnection.prototype[a]=function(){return arguments[0]=new("addIceCandidate"===a?RTCIceCandidate:RTCSessionDescription)(arguments[0]),b.apply(this,arguments)}});var a=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){return null===arguments[0]?(arguments[1]&&arguments[1].apply(null),Promise.resolve()):a.apply(this,arguments)}}};b.exports={shimMediaStream:f.shimMediaStream,shimOnTrack:f.shimOnTrack,shimSourceObject:f.shimSourceObject,shimPeerConnection:f.shimPeerConnection,shimGetUserMedia:a("./getusermedia")}},{"../utils.js":13,"./getusermedia":7}],7:[function(a,b,c){"use strict";var d=a("../utils.js").log;b.exports=function(){var a=function(a){if("object"!=typeof a||a.mandatory||a.optional)return a;var b={};return Object.keys(a).forEach(function(c){if("require"!==c&&"advanced"!==c&&"mediaSource"!==c){var d="object"==typeof a[c]?a[c]:{ideal:a[c]};void 0!==d.exact&&"number"==typeof d.exact&&(d.min=d.max=d.exact);var e=function(a,b){return a?a+b.charAt(0).toUpperCase()+b.slice(1):"deviceId"===b?"sourceId":b};if(void 0!==d.ideal){b.optional=b.optional||[];var f={};"number"==typeof d.ideal?(f[e("min",c)]=d.ideal,b.optional.push(f),f={},f[e("max",c)]=d.ideal,b.optional.push(f)):(f[e("",c)]=d.ideal,b.optional.push(f))}void 0!==d.exact&&"number"!=typeof d.exact?(b.mandatory=b.mandatory||{},b.mandatory[e("",c)]=d.exact):["min","max"].forEach(function(a){void 0!==d[a]&&(b.mandatory=b.mandatory||{},b.mandatory[e(a,c)]=d[a])})}}),a.advanced&&(b.optional=(b.optional||[]).concat(a.advanced)),b},b=function(b,c){if(b=JSON.parse(JSON.stringify(b)),b&&b.audio&&(b.audio=a(b.audio)),b&&"object"==typeof b.video){var e=b.video.facingMode;if((e=e&&("object"==typeof e?e:{ideal:e}))&&("user"===e.exact||"environment"===e.exact||"user"===e.ideal||"environment"===e.ideal)&&(!navigator.mediaDevices.getSupportedConstraints||!navigator.mediaDevices.getSupportedConstraints().facingMode)&&(delete b.video.facingMode,"environment"===e.exact||"environment"===e.ideal))return navigator.mediaDevices.enumerateDevices().then(function(f){f=f.filter(function(a){return"videoinput"===a.kind});var g=f.find(function(a){return-1!==a.label.toLowerCase().indexOf("back")})||f.length&&f[f.length-1];return g&&(b.video.deviceId=e.exact?{exact:g.deviceId}:{ideal:g.deviceId}),b.video=a(b.video),d("chrome: "+JSON.stringify(b)),c(b)});b.video=a(b.video)}return d("chrome: "+JSON.stringify(b)),c(b)},c=function(a){return{name:{PermissionDeniedError:"NotAllowedError",ConstraintNotSatisfiedError:"OverconstrainedError"}[a.name]||a.name,message:a.message,constraint:a.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}},e=function(a,d,e){b(a,function(a){navigator.webkitGetUserMedia(a,d,function(a){e(c(a))})})};navigator.getUserMedia=e;var f=function(a){return new Promise(function(b,c){navigator.getUserMedia(a,b,c)})};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:f,enumerateDevices:function(){return new Promise(function(a){var b={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources(function(c){a(c.map(function(a){return{label:a.label,kind:b[a.kind],deviceId:a.id,groupId:""}}))})})}}),navigator.mediaDevices.getUserMedia){var g=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(a){return b(a,function(a){return g(a).then(function(b){if(a.audio&&!b.getAudioTracks().length||a.video&&!b.getVideoTracks().length)throw b.getTracks().forEach(function(a){a.stop()}),new DOMException("","NotFoundError");return b},function(a){return Promise.reject(c(a))})})}}else navigator.mediaDevices.getUserMedia=function(a){return f(a)};void 0===navigator.mediaDevices.addEventListener&&(navigator.mediaDevices.addEventListener=function(){d("Dummy mediaDevices.addEventListener called.")}),void 0===navigator.mediaDevices.removeEventListener&&(navigator.mediaDevices.removeEventListener=function(){d("Dummy mediaDevices.removeEventListener called.")})}},{"../utils.js":13}],8:[function(a,b,c){"use strict";var d=a("sdp"),e=a("../utils").browserDetails,f={shimPeerConnection:function(){if(window.RTCIceGatherer){window.RTCIceCandidate||(window.RTCIceCandidate=function(a){return a}),window.RTCSessionDescription||(window.RTCSessionDescription=function(a){return a});var a=Object.getOwnPropertyDescriptor(MediaStreamTrack.prototype,"enabled");Object.defineProperty(MediaStreamTrack.prototype,"enabled",{set:function(b){a.set.call(this,b);var c=new Event("enabled");c.enabled=b,this.dispatchEvent(c)}})}window.RTCPeerConnection=function(a){var b=this,c=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(a){b[a]=c[a].bind(c)}),this.onicecandidate=null,this.onaddstream=null,this.ontrack=null,this.onremovestream=null,this.onsignalingstatechange=null,this.oniceconnectionstatechange=null,this.onnegotiationneeded=null,this.ondatachannel=null,this.localStreams=[],this.remoteStreams=[],this.getLocalStreams=function(){return b.localStreams},this.getRemoteStreams=function(){return b.remoteStreams},this.localDescription=new RTCSessionDescription({type:"",sdp:""}),this.remoteDescription=new RTCSessionDescription({type:"",sdp:""}),this.signalingState="stable",this.iceConnectionState="new",this.iceGatheringState="new",this.iceOptions={gatherPolicy:"all",iceServers:[]},a&&a.iceTransportPolicy)switch(a.iceTransportPolicy){case"all":case"relay":this.iceOptions.gatherPolicy=a.iceTransportPolicy;break;case"none":throw new TypeError('iceTransportPolicy "none" not supported')}if(this.usingBundle=a&&"max-bundle"===a.bundlePolicy,a&&a.iceServers){var d=JSON.parse(JSON.stringify(a.iceServers));this.iceOptions.iceServers=d.filter(function(a){if(a&&a.urls){var b=a.urls;return"string"==typeof b&&(b=[b]),!!(b=b.filter(function(a){return 0===a.indexOf("turn:")&&-1!==a.indexOf("transport=udp")&&-1===a.indexOf("turn:[")||0===a.indexOf("stun:")&&e.version>=14393})[0])}return!1})}this._config=a,this.transceivers=[],this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype._emitBufferedCandidates=function(){var a=this,b=d.splitSections(a.localDescription.sdp);this._localIceCandidatesBuffer.forEach(function(c){if(c.candidate&&0!==Object.keys(c.candidate).length)-1===c.candidate.candidate.indexOf("typ endOfCandidates")&&(b[c.candidate.sdpMLineIndex+1]+="a="+c.candidate.candidate+"\r\n");else for(var d=1;d<b.length;d++)-1===b[d].indexOf("\r\na=end-of-candidates\r\n")&&(b[d]+="a=end-of-candidates\r\n");if(a.localDescription.sdp=b.join(""),a.dispatchEvent(c),null!==a.onicecandidate&&a.onicecandidate(c),!c.candidate&&"complete"!==a.iceGatheringState){a.transceivers.every(function(a){return a.iceGatherer&&"completed"===a.iceGatherer.state})&&(a.iceGatheringState="complete")}}),this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype.getConfiguration=function(){return this._config},window.RTCPeerConnection.prototype.addStream=function(a){var b=a.clone();a.getTracks().forEach(function(a,c){var d=b.getTracks()[c];a.addEventListener("enabled",function(a){d.enabled=a.enabled})}),this.localStreams.push(b),this._maybeFireNegotiationNeeded()},window.RTCPeerConnection.prototype.removeStream=function(a){var b=this.localStreams.indexOf(a);b>-1&&(this.localStreams.splice(b,1),this._maybeFireNegotiationNeeded())},window.RTCPeerConnection.prototype.getSenders=function(){return this.transceivers.filter(function(a){return!!a.rtpSender}).map(function(a){return a.rtpSender})},window.RTCPeerConnection.prototype.getReceivers=function(){return this.transceivers.filter(function(a){return!!a.rtpReceiver}).map(function(a){return a.rtpReceiver})},window.RTCPeerConnection.prototype._getCommonCapabilities=function(a,b){var c={codecs:[],headerExtensions:[],fecMechanisms:[]};return a.codecs.forEach(function(a){for(var d=0;d<b.codecs.length;d++){var e=b.codecs[d];if(a.name.toLowerCase()===e.name.toLowerCase()&&a.clockRate===e.clockRate){e.numChannels=Math.min(a.numChannels,e.numChannels),c.codecs.push(e),e.rtcpFeedback=e.rtcpFeedback.filter(function(b){for(var c=0;c<a.rtcpFeedback.length;c++)if(a.rtcpFeedback[c].type===b.type&&a.rtcpFeedback[c].parameter===b.parameter)return!0;return!1});break}}}),a.headerExtensions.forEach(function(a){for(var d=0;d<b.headerExtensions.length;d++){var e=b.headerExtensions[d];if(a.uri===e.uri){c.headerExtensions.push(e);break}}}),c},window.RTCPeerConnection.prototype._createIceAndDtlsTransports=function(a,b){var c=this,e=new RTCIceGatherer(c.iceOptions),f=new RTCIceTransport(e);e.onlocalcandidate=function(g){var h=new Event("icecandidate");h.candidate={sdpMid:a,sdpMLineIndex:b};var i=g.candidate,j=!i||0===Object.keys(i).length;j?(void 0===e.state&&(e.state="completed"),h.candidate.candidate="candidate:1 1 udp 1 0.0.0.0 9 typ endOfCandidates"):(i.component="RTCP"===f.component?2:1,h.candidate.candidate=d.writeCandidate(i));var k=d.splitSections(c.localDescription.sdp);-1===h.candidate.candidate.indexOf("typ endOfCandidates")?k[h.candidate.sdpMLineIndex+1]+="a="+h.candidate.candidate+"\r\n":k[h.candidate.sdpMLineIndex+1]+="a=end-of-candidates\r\n",c.localDescription.sdp=k.join("");var l=c.transceivers.every(function(a){return a.iceGatherer&&"completed"===a.iceGatherer.state});switch(c.iceGatheringState){case"new":c._localIceCandidatesBuffer.push(h),j&&l&&c._localIceCandidatesBuffer.push(new Event("icecandidate"));break;case"gathering":c._emitBufferedCandidates(),c.dispatchEvent(h),null!==c.onicecandidate&&c.onicecandidate(h),l&&(c.dispatchEvent(new Event("icecandidate")),null!==c.onicecandidate&&c.onicecandidate(new Event("icecandidate")),c.iceGatheringState="complete")}},f.onicestatechange=function(){c._updateConnectionState()};var g=new RTCDtlsTransport(f);return g.ondtlsstatechange=function(){c._updateConnectionState()},g.onerror=function(){g.state="failed",c._updateConnectionState()},{iceGatherer:e,iceTransport:f,dtlsTransport:g}},window.RTCPeerConnection.prototype._transceive=function(a,b,c){var e=this._getCommonCapabilities(a.localCapabilities,a.remoteCapabilities);b&&a.rtpSender&&(e.encodings=a.sendEncodingParameters,e.rtcp={cname:d.localCName},a.recvEncodingParameters.length&&(e.rtcp.ssrc=a.recvEncodingParameters[0].ssrc),a.rtpSender.send(e)),c&&a.rtpReceiver&&("video"===a.kind&&a.recvEncodingParameters&&a.recvEncodingParameters.forEach(function(a){delete a.rtx}),e.encodings=a.recvEncodingParameters,e.rtcp={cname:a.cname},a.sendEncodingParameters.length&&(e.rtcp.ssrc=a.sendEncodingParameters[0].ssrc),a.rtpReceiver.receive(e))},window.RTCPeerConnection.prototype.setLocalDescription=function(a){var b,c,e=this;if("offer"===a.type)this._pendingOffer&&(b=d.splitSections(a.sdp),c=b.shift(),b.forEach(function(a,b){var c=d.parseRtpParameters(a);e._pendingOffer[b].localCapabilities=c}),this.transceivers=this._pendingOffer,delete this._pendingOffer);else if("answer"===a.type){b=d.splitSections(e.remoteDescription.sdp),c=b.shift();var f=d.matchPrefix(c,"a=ice-lite").length>0;b.forEach(function(a,b){var g=e.transceivers[b],h=g.iceGatherer,i=g.iceTransport,j=g.dtlsTransport,k=g.localCapabilities,l=g.remoteCapabilities;if("0"!==a.split("\n",1)[0].split(" ",2)[1]&&!g.isDatachannel){var m=d.getIceParameters(a,c);if(f){var n=d.matchPrefix(a,"a=candidate:").map(function(a){return d.parseCandidate(a)}).filter(function(a){return"1"===a.component});n.length&&i.setRemoteCandidates(n)}var o=d.getDtlsParameters(a,c);f&&(o.role="server"),e.usingBundle&&0!==b||(i.start(h,m,f?"controlling":"controlled"),j.start(o));var p=e._getCommonCapabilities(k,l);e._transceive(g,p.codecs.length>0,!1)}})}switch(this.localDescription={type:a.type,sdp:a.sdp},a.type){case"offer":this._updateSignalingState("have-local-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+a.type+'"')}var g=arguments.length>1&&"function"==typeof arguments[1];if(g){var h=arguments[1];window.setTimeout(function(){h(),"new"===e.iceGatheringState&&(e.iceGatheringState="gathering"),e._emitBufferedCandidates()},0)}var i=Promise.resolve();return i.then(function(){g||("new"===e.iceGatheringState&&(e.iceGatheringState="gathering"),window.setTimeout(e._emitBufferedCandidates.bind(e),500))}),i},window.RTCPeerConnection.prototype.setRemoteDescription=function(a){var b=this,c=new MediaStream,e=[],f=d.splitSections(a.sdp),g=f.shift(),h=d.matchPrefix(g,"a=ice-lite").length>0;switch(this.usingBundle=d.matchPrefix(g,"a=group:BUNDLE ").length>0,f.forEach(function(f,i){var j=d.splitLines(f),k=j[0].substr(2).split(" "),l=k[0],m="0"===k[1],n=d.getDirection(f,g),o=d.matchPrefix(f,"a=mid:");if(o=o.length?o[0].substr(6):d.generateIdentifier(),"application"===l&&"DTLS/SCTP"===k[2])return void(b.transceivers[i]={mid:o,isDatachannel:!0});var p,q,r,s,t,u,v,w,x,y,z,A,B=d.parseRtpParameters(f);m||(z=d.getIceParameters(f,g),A=d.getDtlsParameters(f,g),A.role="client"),w=d.parseRtpEncodingParameters(f);var C,D=d.matchPrefix(f,"a=ssrc:").map(function(a){return d.parseSsrcMedia(a)}).filter(function(a){return"cname"===a.attribute})[0];D&&(C=D.value);var E=d.matchPrefix(f,"a=end-of-candidates",g).length>0,F=d.matchPrefix(f,"a=candidate:").map(function(a){return d.parseCandidate(a)}).filter(function(a){return"1"===a.component});if("offer"!==a.type||m)"answer"!==a.type||m||(p=b.transceivers[i],q=p.iceGatherer,r=p.iceTransport,s=p.dtlsTransport,t=p.rtpSender,u=p.rtpReceiver,v=p.sendEncodingParameters,x=p.localCapabilities,b.transceivers[i].recvEncodingParameters=w,b.transceivers[i].remoteCapabilities=B,b.transceivers[i].cname=C,(h||E)&&F.length&&r.setRemoteCandidates(F),b.usingBundle&&0!==i||(r.start(q,z,"controlling"),s.start(A)),b._transceive(p,"sendrecv"===n||"recvonly"===n,"sendrecv"===n||"sendonly"===n),!u||"sendrecv"!==n&&"sendonly"!==n?delete p.rtpReceiver:(y=u.track,e.push([y,u]),c.addTrack(y)));else{var G=b.usingBundle&&i>0?{iceGatherer:b.transceivers[0].iceGatherer,iceTransport:b.transceivers[0].iceTransport,dtlsTransport:b.transceivers[0].dtlsTransport}:b._createIceAndDtlsTransports(o,i);if(E&&G.iceTransport.setRemoteCandidates(F),x=RTCRtpReceiver.getCapabilities(l),x.codecs=x.codecs.filter(function(a){return"rtx"!==a.name}),v=[{ssrc:1001*(2*i+2)}],u=new RTCRtpReceiver(G.dtlsTransport,l),y=u.track,e.push([y,u]),c.addTrack(y),b.localStreams.length>0&&b.localStreams[0].getTracks().length>=i){var H;"audio"===l?H=b.localStreams[0].getAudioTracks()[0]:"video"===l&&(H=b.localStreams[0].getVideoTracks()[0]),H&&(t=new RTCRtpSender(H,G.dtlsTransport))}b.transceivers[i]={iceGatherer:G.iceGatherer,iceTransport:G.iceTransport,dtlsTransport:G.dtlsTransport,localCapabilities:x,remoteCapabilities:B,rtpSender:t,rtpReceiver:u,kind:l,mid:o,cname:C,sendEncodingParameters:v,recvEncodingParameters:w},b._transceive(b.transceivers[i],!1,"sendrecv"===n||"sendonly"===n)}}),this.remoteDescription={type:a.type,sdp:a.sdp},a.type){case"offer":this._updateSignalingState("have-remote-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+a.type+'"')}return c.getTracks().length&&(b.remoteStreams.push(c),window.setTimeout(function(){var a=new Event("addstream");a.stream=c,b.dispatchEvent(a),null!==b.onaddstream&&window.setTimeout(function(){b.onaddstream(a)},0),e.forEach(function(d){var e=d[0],f=d[1],g=new Event("track");g.track=e,g.receiver=f,g.streams=[c],b.dispatchEvent(a),null!==b.ontrack&&window.setTimeout(function(){b.ontrack(g)},0)})},0)),arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.close=function(){this.transceivers.forEach(function(a){a.iceTransport&&a.iceTransport.stop(),a.dtlsTransport&&a.dtlsTransport.stop(),a.rtpSender&&a.rtpSender.stop(),a.rtpReceiver&&a.rtpReceiver.stop()}),this._updateSignalingState("closed")},window.RTCPeerConnection.prototype._updateSignalingState=function(a){this.signalingState=a;var b=new Event("signalingstatechange");this.dispatchEvent(b),null!==this.onsignalingstatechange&&this.onsignalingstatechange(b)},window.RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){var a=new Event("negotiationneeded");this.dispatchEvent(a),null!==this.onnegotiationneeded&&this.onnegotiationneeded(a)},window.RTCPeerConnection.prototype._updateConnectionState=function(){var a,b=this,c={new:0,closed:0,connecting:0,checking:0,connected:0,completed:0,failed:0};if(this.transceivers.forEach(function(a){c[a.iceTransport.state]++,c[a.dtlsTransport.state]++}),c.connected+=c.completed,a="new",c.failed>0?a="failed":c.connecting>0||c.checking>0?a="connecting":c.disconnected>0?a="disconnected":c.new>0?a="new":(c.connected>0||c.completed>0)&&(a="connected"),a!==b.iceConnectionState){b.iceConnectionState=a;var d=new Event("iceconnectionstatechange");this.dispatchEvent(d),null!==this.oniceconnectionstatechange&&this.oniceconnectionstatechange(d)}},window.RTCPeerConnection.prototype.createOffer=function(){
var a=this;if(this._pendingOffer)throw new Error("createOffer called while there is a pending offer.");var b;1===arguments.length&&"function"!=typeof arguments[0]?b=arguments[0]:3===arguments.length&&(b=arguments[2]);var c=[],e=0,f=0;if(this.localStreams.length&&(e=this.localStreams[0].getAudioTracks().length,f=this.localStreams[0].getVideoTracks().length),b){if(b.mandatory||b.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==b.offerToReceiveAudio&&(e=b.offerToReceiveAudio),void 0!==b.offerToReceiveVideo&&(f=b.offerToReceiveVideo)}for(this.localStreams.length&&this.localStreams[0].getTracks().forEach(function(a){c.push({kind:a.kind,track:a,wantReceive:"audio"===a.kind?e>0:f>0}),"audio"===a.kind?e--:"video"===a.kind&&f--});e>0||f>0;)e>0&&(c.push({kind:"audio",wantReceive:!0}),e--),f>0&&(c.push({kind:"video",wantReceive:!0}),f--);var g=d.writeSessionBoilerplate(),h=[];c.forEach(function(b,c){var e=b.track,f=b.kind,g=d.generateIdentifier(),i=a.usingBundle&&c>0?{iceGatherer:h[0].iceGatherer,iceTransport:h[0].iceTransport,dtlsTransport:h[0].dtlsTransport}:a._createIceAndDtlsTransports(g,c),j=RTCRtpSender.getCapabilities(f);j.codecs=j.codecs.filter(function(a){return"rtx"!==a.name}),j.codecs.forEach(function(a){"H264"===a.name&&void 0===a.parameters["level-asymmetry-allowed"]&&(a.parameters["level-asymmetry-allowed"]="1")});var k,l,m=[{ssrc:1001*(2*c+1)}];e&&(k=new RTCRtpSender(e,i.dtlsTransport)),b.wantReceive&&(l=new RTCRtpReceiver(i.dtlsTransport,f)),h[c]={iceGatherer:i.iceGatherer,iceTransport:i.iceTransport,dtlsTransport:i.dtlsTransport,localCapabilities:j,remoteCapabilities:null,rtpSender:k,rtpReceiver:l,kind:f,mid:g,sendEncodingParameters:m,recvEncodingParameters:null}}),this.usingBundle&&(g+="a=group:BUNDLE "+h.map(function(a){return a.mid}).join(" ")+"\r\n"),c.forEach(function(b,c){var e=h[c];g+=d.writeMediaSection(e,e.localCapabilities,"offer",a.localStreams[0])}),this._pendingOffer=h;var i=new RTCSessionDescription({type:"offer",sdp:g});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,i),Promise.resolve(i)},window.RTCPeerConnection.prototype.createAnswer=function(){var a=this,b=d.writeSessionBoilerplate();this.usingBundle&&(b+="a=group:BUNDLE "+this.transceivers.map(function(a){return a.mid}).join(" ")+"\r\n"),this.transceivers.forEach(function(c){if(c.isDatachannel)return void(b+="m=application 0 DTLS/SCTP 5000\r\nc=IN IP4 0.0.0.0\r\na=mid:"+c.mid+"\r\n");var e=a._getCommonCapabilities(c.localCapabilities,c.remoteCapabilities);b+=d.writeMediaSection(c,e,"answer",a.localStreams[0])});var c=new RTCSessionDescription({type:"answer",sdp:b});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,c),Promise.resolve(c)},window.RTCPeerConnection.prototype.addIceCandidate=function(a){if(null===a)this.transceivers.forEach(function(a){a.iceTransport.addRemoteCandidate({})});else{var b=a.sdpMLineIndex;if(a.sdpMid)for(var c=0;c<this.transceivers.length;c++)if(this.transceivers[c].mid===a.sdpMid){b=c;break}var e=this.transceivers[b];if(e){var f=Object.keys(a.candidate).length>0?d.parseCandidate(a.candidate):{};if("tcp"===f.protocol&&(0===f.port||9===f.port))return;if("1"!==f.component)return;"endOfCandidates"===f.type&&(f={}),e.iceTransport.addRemoteCandidate(f);var g=d.splitSections(this.remoteDescription.sdp);g[b+1]+=(f.type?a.candidate.trim():"a=end-of-candidates")+"\r\n",this.remoteDescription.sdp=g.join("")}}return arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.getStats=function(){var a=[];this.transceivers.forEach(function(b){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(c){b[c]&&a.push(b[c].getStats())})});var b=arguments.length>1&&"function"==typeof arguments[1]&&arguments[1];return new Promise(function(c){var d=new Map;Promise.all(a).then(function(a){a.forEach(function(a){Object.keys(a).forEach(function(b){d.set(b,a[b]),d[b]=a[b]})}),b&&window.setTimeout(b,0,d),c(d)})})}}};b.exports={shimPeerConnection:f.shimPeerConnection,shimGetUserMedia:a("./getusermedia")}},{"../utils":13,"./getusermedia":9,sdp:1}],9:[function(a,b,c){"use strict";b.exports=function(){var a=function(a){return{name:{PermissionDeniedError:"NotAllowedError"}[a.name]||a.name,message:a.message,constraint:a.constraint,toString:function(){return this.name}}},b=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(c){return b(c).catch(function(b){return Promise.reject(a(b))})}}},{}],10:[function(a,b,c){"use strict";var d=a("../utils").browserDetails,e={shimOnTrack:function(){"object"!=typeof window||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(a){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=a),this.addEventListener("addstream",this._ontrackpoly=function(a){a.stream.getTracks().forEach(function(b){var c=new Event("track");c.track=b,c.receiver={track:b},c.streams=[a.stream],this.dispatchEvent(c)}.bind(this))}.bind(this))}})},shimSourceObject:function(){"object"==typeof window&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(a){this.mozSrcObject=a}}))},shimPeerConnection:function(){if("object"==typeof window&&(window.RTCPeerConnection||window.mozRTCPeerConnection)){window.RTCPeerConnection||(window.RTCPeerConnection=function(a,b){if(d.version<38&&a&&a.iceServers){for(var c=[],e=0;e<a.iceServers.length;e++){var f=a.iceServers[e];if(f.hasOwnProperty("urls"))for(var g=0;g<f.urls.length;g++){var h={url:f.urls[g]};0===f.urls[g].indexOf("turn")&&(h.username=f.username,h.credential=f.credential),c.push(h)}else c.push(a.iceServers[e])}a.iceServers=c}return new mozRTCPeerConnection(a,b)},window.RTCPeerConnection.prototype=mozRTCPeerConnection.prototype,mozRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return mozRTCPeerConnection.generateCertificate}}),window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(a){var b=RTCPeerConnection.prototype[a];RTCPeerConnection.prototype[a]=function(){return arguments[0]=new("addIceCandidate"===a?RTCIceCandidate:RTCSessionDescription)(arguments[0]),b.apply(this,arguments)}});var a=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){return null===arguments[0]?(arguments[1]&&arguments[1].apply(null),Promise.resolve()):a.apply(this,arguments)};var b=function(a){var b=new Map;return Object.keys(a).forEach(function(c){b.set(c,a[c]),b[c]=a[c]}),b},c=RTCPeerConnection.prototype.getStats;RTCPeerConnection.prototype.getStats=function(a,d,e){return c.apply(this,[a||null]).then(function(a){return b(a)}).then(d,e)}}}};b.exports={shimOnTrack:e.shimOnTrack,shimSourceObject:e.shimSourceObject,shimPeerConnection:e.shimPeerConnection,shimGetUserMedia:a("./getusermedia")}},{"../utils":13,"./getusermedia":11}],11:[function(a,b,c){"use strict";var d=a("../utils").log,e=a("../utils").browserDetails;b.exports=function(){var a=function(a){return{name:{SecurityError:"NotAllowedError",PermissionDeniedError:"NotAllowedError"}[a.name]||a.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[a.message]||a.message,constraint:a.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},b=function(b,c,f){var g=function(a){if("object"!=typeof a||a.require)return a;var b=[];return Object.keys(a).forEach(function(c){if("require"!==c&&"advanced"!==c&&"mediaSource"!==c){var d=a[c]="object"==typeof a[c]?a[c]:{ideal:a[c]};if(void 0===d.min&&void 0===d.max&&void 0===d.exact||b.push(c),void 0!==d.exact&&("number"==typeof d.exact?d.min=d.max=d.exact:a[c]=d.exact,delete d.exact),void 0!==d.ideal){a.advanced=a.advanced||[];var e={};"number"==typeof d.ideal?e[c]={min:d.ideal,max:d.ideal}:e[c]=d.ideal,a.advanced.push(e),delete d.ideal,Object.keys(d).length||delete a[c]}}}),b.length&&(a.require=b),a};return b=JSON.parse(JSON.stringify(b)),e.version<38&&(d("spec: "+JSON.stringify(b)),b.audio&&(b.audio=g(b.audio)),b.video&&(b.video=g(b.video)),d("ff37: "+JSON.stringify(b))),navigator.mozGetUserMedia(b,c,function(b){f(a(b))})},c=function(a){return new Promise(function(c,d){b(a,c,d)})};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:c,addEventListener:function(){},removeEventListener:function(){}}),navigator.mediaDevices.enumerateDevices=navigator.mediaDevices.enumerateDevices||function(){return new Promise(function(a){a([{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}])})},e.version<41){var f=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=function(){return f().then(void 0,function(a){if("NotFoundError"===a.name)return[];throw a})}}if(e.version<49){var g=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(b){return g(b).then(function(a){if(b.audio&&!a.getAudioTracks().length||b.video&&!a.getVideoTracks().length)throw a.getTracks().forEach(function(a){a.stop()}),new DOMException("The object can not be found here.","NotFoundError");return a},function(b){return Promise.reject(a(b))})}}navigator.getUserMedia=function(a,c,d){if(e.version<44)return b(a,c,d);console.warn("navigator.getUserMedia has been replaced by navigator.mediaDevices.getUserMedia"),navigator.mediaDevices.getUserMedia(a).then(c,d)}}},{"../utils":13}],12:[function(a,b,c){"use strict";var d={shimGetUserMedia:function(){navigator.getUserMedia=navigator.webkitGetUserMedia}};b.exports={shimGetUserMedia:d.shimGetUserMedia}},{}],13:[function(a,b,c){"use strict";var d=!0,e={disableLog:function(a){return"boolean"!=typeof a?new Error("Argument type: "+typeof a+". Please use a boolean."):(d=a,a?"adapter.js logging disabled":"adapter.js logging enabled")},log:function(){if("object"==typeof window){if(d)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},extractVersion:function(a,b,c){var d=a.match(b);return d&&d.length>=c&&parseInt(d[c],10)},detectBrowser:function(){var a={};if(a.browser=null,a.version=null,"undefined"==typeof window||!window.navigator)return a.browser="Not a browser.",a;if(navigator.mozGetUserMedia)a.browser="firefox",a.version=this.extractVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1);else if(navigator.webkitGetUserMedia)if(window.webkitRTCPeerConnection)a.browser="chrome",a.version=this.extractVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2);else{if(!navigator.userAgent.match(/Version\/(\d+).(\d+)/))return a.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",a;a.browser="safari",a.version=this.extractVersion(navigator.userAgent,/AppleWebKit\/([0-9]+)\./,1)}else{if(!navigator.mediaDevices||!navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))return a.browser="Not a supported browser.",a;a.browser="edge",a.version=this.extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2)}return a}};b.exports={log:e.log,disableLog:e.disableLog,browserDetails:e.detectBrowser(),extractVersion:e.extractVersion}},{}],14:[function(a,b,c){(function(b){"use strict";a("webrtc-adapter");var c=a("./rtc_session"),d=function(a){return a&&a.__esModule?a:{default:a}}(c),e=a("./rtc_const");/**
 * @license
 * License info for uuid module assembled into js bundle:
 * 
 * The MIT License (MIT)
 * 
 * Copyright (c) 2010-2016 Robert Kieffer and other contributors
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
b.connect=b.connect||{},/**
                                        * @license
                                        * Copyright 2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.
                                        *
                                        * Licensed under the Amazon Software License (the "License"). You may not use this file except in compliance with the License. A copy of the License is located at
                                        *
                                        *   http://aws.amazon.com/asl/
                                        *
                                        * or in the "LICENSE" file accompanying this file. This file is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions and limitations under the License.
                                        */
/**
 * @license
 * License info for webrtc-adapter module assembled into js bundle:
 * 
 * Copyright (c) 2014, The WebRTC project authors. All rights reserved.
 * 
 * Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:
 * 
 * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
 * 
 * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
 * 
 * Neither the name of Google nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
/**
 * @license
 * License info for sdp module assembled into js bundle:
 * 
 * See https://www.npmjs.com/package/sdp
 */
b.connect.RTCSession=d.default,b.connect.RTCErrors=e.RTC_ERRORS,b.lily=b.lily||{},b.lily.RTCSession=d.default,b.lily.RTCErrors=e.RTC_ERRORS}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./rtc_const":16,"./rtc_session":17,"webrtc-adapter":5}],15:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}Object.defineProperty(c,"__esModule",{value:!0});var g=c.TimeoutExceptionName="Timeout",h=c.Timeout=function(a){function b(a){d(this,b);var c=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return c.name=g,c}return f(b,a),b}(Error),i=c.GumTimeoutExceptionName="GumTimeout",j=(c.GumTimeout=function(a){function b(a){d(this,b);var c=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return c.name=i,c}return f(b,a),b}(h),c.IllegalParametersExceptionName="IllegalParameters"),k=(c.IllegalParameters=function(a){function b(a){d(this,b);var c=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return c.name=j,c}return f(b,a),b}(Error),c.IllegalStateExceptionName="IllegalState"),l=(c.IllegalState=function(a){function b(a){d(this,b);var c=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return c.name=k,c}return f(b,a),b}(Error),c.UnsupportedOperationExceptionName="UnsupportedOperation"),m=(c.UnsupportedOperation=function(a){function b(a){d(this,b);var c=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return c.name=l,c}return f(b,a),b}(Error),c.BusyExceptionName="BusyException"),n=(c.BusyException=function(a){function b(a){d(this,b);var c=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return c.name=m,c}return f(b,a),b}(Error),c.CallNotFoundExceptionName="CallNotFoundException"),o=(c.CallNotFoundException=function(a){function b(a){d(this,b);var c=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return c.name=n,c}return f(b,a),b}(Error),c.UnknownSignalingErrorName="UnknownSignalingError");c.UnknownSignalingError=function(a){function b(){d(this,b);var a=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.name=o,a}return f(b,a),b}(Error)},{}],16:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0});c.MAX_ACCEPT_BYE_DELAY_MS=2e3,c.MAX_INVITE_DELAY_MS=5e3,c.DEFAULT_CONNECT_TIMEOUT_MS=1e4,c.DEFAULT_ICE_TIMEOUT_MS=8e3,c.DEFAULT_GUM_TIMEOUT_MS=1e4,c.RTC_ERRORS={ICE_COLLECTION_TIMEOUT:"Ice Collection Timeout",USER_BUSY:"User Busy",SIGNALLING_CONNECTION_FAILURE:"Signalling Connection Failure",SIGNALLING_HANDSHAKE_FAILURE:"Signalling Handshake Failure",SET_REMOTE_DESCRIPTION_FAILURE:"Set Remote Description Failure",CREATE_OFFER_FAILURE:"Create Offer Failure",SET_LOCAL_DESCRIPTION_FAILURE:"Set Local Description Failure",INVALID_REMOTE_SDP:"Invalid Remote SDP",NO_REMOTE_ICE_CANDIDATE:"No Remote ICE Candidate",GUM_TIMEOUT_FAILURE:"GUM Timeout Failure",GUM_OTHER_FAILURE:"GUM Other Failure",CALL_NOT_FOUND:"Call Not Found"}},{}],17:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{default:a}}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function g(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(c,"__esModule",{value:!0}),c.FailedState=c.DisconnectedState=c.CleanUpState=c.TalkingState=c.AcceptState=c.InviteAnswerState=c.ConnectSignalingAndIceCollectionState=c.SetLocalSessionDescriptionState=c.CreateOfferState=c.GrabLocalMediaState=c.RTCSessionState=void 0;var h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},i=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},j=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),k=a("./utils"),l=a("./session_report"),m=a("./rtc_const"),n=a("./exceptions"),o=a("./signaling"),p=d(o),q=a("uuid/v4"),r=d(q),s=a("./rtp-stats"),t=a("sdp"),u=c.RTCSessionState=function(){function a(b){g(this,a),this._rtcSession=b}return j(a,[{key:"onEnter",value:function(){}},{key:"onExit",value:function(){}},{key:"_isCurrentState",value:function(){return this._rtcSession._state===this}},{key:"transit",value:function(a){this._isCurrentState()&&this._rtcSession.transit(a)}},{key:"hangup",value:function(){this.transit(new E(this._rtcSession))}},{key:"onIceCandidate",value:function(a){}},{key:"onRemoteHungup",value:function(){throw new n.UnsupportedOperation("onRemoteHungup not implemented by "+this.name)}},{key:"onSignalingConnected",value:function(){throw new n.UnsupportedOperation("onSignalingConnected not implemented by "+this.name)}},{key:"onSignalingHandshaked",value:function(){throw new n.UnsupportedOperation("onSignalingHandshaked not implemented by "+this.name)}},{key:"onSignalingFailed",value:function(a){throw new n.UnsupportedOperation("onSignalingFailed not implemented by "+this.name)}},{key:"onIceStateChange",value:function(a){}},{key:"logger",get:function(){return this._rtcSession._logger}},{key:"name",get:function(){return"RTCSessionState"}}]),a}(),v=c.GrabLocalMediaState=function(a){function b(){return g(this,b),e(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return f(b,a),j(b,[{key:"onEnter",value:function(){var a=this,b=Date.now();if(a._rtcSession._userAudioStream)a.transit(new w(a._rtcSession));else{var c=new Promise(function(b,c){setTimeout(function(){c(new n.GumTimeout("Local media has not been initialized yet."))},a._rtcSession._gumTimeoutMillis)}),d=a._gUM(a._rtcSession._buildMediaConstraints());Promise.race([d,c]).then(function(c){a._rtcSession._sessionReport.gumTimeMillis=Date.now()-b,a._rtcSession._onGumSuccess(a._rtcSession),a._rtcSession._localStream=c,a._rtcSession._sessionReport.gumOtherFailure=!1,a._rtcSession._sessionReport.gumTimeoutFailure=!1,a.transit(new w(a._rtcSession))}).catch(function(c){a._rtcSession._sessionReport.gumTimeMillis=Date.now()-b;var d;c instanceof n.GumTimeout?(d=m.RTC_ERRORS.GUM_TIMEOUT_FAILURE,a._rtcSession._sessionReport.gumTimeoutFailure=!0,a._rtcSession._sessionReport.gumOtherFailure=!1):(d=m.RTC_ERRORS.GUM_OTHER_FAILURE,a._rtcSession._sessionReport.gumOtherFailure=!0,a._rtcSession._sessionReport.gumTimeoutFailure=!1),a.logger.error("Local media initialization failed",c),a._rtcSession._onGumError(a._rtcSession),a.transit(new E(a._rtcSession,d))})}}},{key:"_gUM",value:function(a){return navigator.mediaDevices.getUserMedia(a)}},{key:"name",get:function(){return"GrabLocalMediaState"}}]),b}(u),w=c.CreateOfferState=function(a){function b(){return g(this,b),e(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return f(b,a),j(b,[{key:"onEnter",value:function(){var a=this,b=a._rtcSession._localStream;a._rtcSession._pc.addStream(b),a._rtcSession._onLocalStreamAdded(a._rtcSession,b),a._rtcSession._pc.createOffer().then(function(b){a._rtcSession._localSessionDescription=b,a._rtcSession._sessionReport.createOfferFailure=!1,a.transit(new x(a._rtcSession))}).catch(function(b){a.logger.error("CreateOffer failed",b),a._rtcSession._sessionReport.createOfferFailure=!0,a.transit(new E(a._rtcSession,m.RTC_ERRORS.CREATE_OFFER_FAILURE))})}},{key:"name",get:function(){return"CreateOfferState"}}]),b}(u),x=c.SetLocalSessionDescriptionState=function(a){function b(){return g(this,b),e(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return f(b,a),j(b,[{key:"onEnter",value:function(){var a=this,b=a._rtcSession._localSessionDescription,c=new k.SdpOptions;a._rtcSession._forceAudioCodec&&(c.forceCodec.audio=a._rtcSession._forceAudioCodec),a._rtcSession._forceVideoCodec&&(c.forceCodec.video=a._rtcSession._forceVideoCodec),c.enableOpusDtx=a._rtcSession._enableOpusDtx;var d=(0,k.transformSdp)(b.sdp,c);b.sdp=d.sdp,a.logger.info("LocalSD",a._rtcSession._localSessionDescription),a._rtcSession._pc.setLocalDescription(a._rtcSession._localSessionDescription).then(function(){var b=Date.now()-a._rtcSession._connectTimeStamp;a._rtcSession._sessionReport.initializationTimeMillis=b,a._rtcSession._onSessionInitialized(a._rtcSession,b),a._rtcSession._sessionReport.setLocalDescriptionFailure=!1,a.transit(new y(a._rtcSession,d.mLines))}).catch(function(b){a.logger.error("SetLocalDescription failed",b),a._rtcSession._sessionReport.setLocalDescriptionFailure=!0,a.transit(new E(a._rtcSession,m.RTC_ERRORS.SET_LOCAL_DESCRIPTION_FAILURE))})}},{key:"name",get:function(){return"SetLocalSessionDescriptionState"}}]),b}(u),y=c.ConnectSignalingAndIceCollectionState=function(a){function b(a,c){g(this,b);var d=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return d._iceCandidates=[],d._iceCandidateFoundationsMap={},d._mLines=c,d}return f(b,a),j(b,[{key:"onEnter",value:function(){var a=this;a._startTime=Date.now(),setTimeout(function(){a._isCurrentState()&&!a._iceCompleted&&(a.logger.warn("ICE collection timed out"),a._reportIceCompleted(!0))},a._rtcSession._iceTimeoutMillis),a._rtcSession._createSignalingChannel().connect()}},{key:"onSignalingConnected",value:function(){this._rtcSession._signallingConnectTimestamp=Date.now(),this._rtcSession._sessionReport.signallingConnectTimeMillis=this._rtcSession._signallingConnectTimestamp-this._startTime,this._signalingConnected=!0,this._rtcSession._onSignalingConnected(this._rtcSession),this._rtcSession._sessionReport.signallingConnectionFailure=!1,this._checkAndTransit()}},{key:"onSignalingFailed",value:function(a){this._rtcSession._sessionReport.signallingConnectTimeMillis=Date.now()-this._startTime,this.logger.error("Failed connecting to signaling server",a),this._rtcSession._sessionReport.signallingConnectionFailure=!0,this.transit(new E(this._rtcSession,m.RTC_ERRORS.SIGNALLING_CONNECTION_FAILURE))}},{key:"_createLocalCandidate",value:function(a){return new RTCIceCandidate(a)}},{key:"onIceCandidate",value:function(a){var b=a.candidate;this.logger.log("onicecandidate "+JSON.stringify(b)),b?(this._iceCandidates.push(this._createLocalCandidate(b)),this._iceCompleted||this._checkCandidatesSufficient(b)):this._reportIceCompleted(!1)}},{key:"_checkCandidatesSufficient",value:function(a){var b=(0,t.parseCandidate)(a.candidate);if(1==b.component){var c=b.foundation,d=a.sdpMLineIndex;if(c&&d>=0&&d<this._mLines){var e=this._iceCandidateFoundationsMap[c]||[];e.includes(d)||e.push(d),this._iceCandidateFoundationsMap[c]=e,this._mLines==e.length&&this._reportIceCompleted(!1)}}}},{key:"_reportIceCompleted",value:function(a){this._rtcSession._sessionReport.iceCollectionTimeMillis=Date.now()-this._startTime,this._iceCompleted=!0,this._rtcSession._onIceCollectionComplete(this._rtcSession,a,this._iceCandidates.length),this._iceCandidates.length>0?(this._rtcSession._sessionReport.iceCollectionFailure=!1,this._checkAndTransit()):(this.logger.error("No ICE candidate"),this._rtcSession._sessionReport.iceCollectionFailure=!0,this.transit(new E(this._rtcSession,m.RTC_ERRORS.ICE_COLLECTION_TIMEOUT)))}},{key:"_checkAndTransit",value:function(){this._iceCompleted&&this._signalingConnected?this.transit(new z(this._rtcSession,this._iceCandidates)):this._iceCompleted?this.logger.log("Pending signaling connection"):this.logger.log("Pending ICE collection")}},{key:"name",get:function(){return"ConnectSignalingAndIceCollectionState"}}]),b}(u),z=c.InviteAnswerState=function(a){function b(a,c){g(this,b);var d=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return d._iceCandidates=c,d}return f(b,a),j(b,[{key:"onEnter",value:function(){var a=this._rtcSession;a._onSignalingStarted(a),a._signalingChannel.invite(a._localSessionDescription.sdp,this._iceCandidates)}},{key:"onSignalingAnswered",value:function(a,b){this._rtcSession._sessionReport.userBusyFailure=!1,this._rtcSession._sessionReport.handshakingFailure=!1,this.transit(new A(this._rtcSession,a,b))}},{key:"onSignalingFailed",value:function(a){var b;a.name==n.BusyExceptionName?(this.logger.error("User Busy, possibly multiple CCP windows open",a),this._rtcSession._sessionReport.userBusyFailure=!0,this._rtcSession._sessionReport.handshakingFailure=!0,b=m.RTC_ERRORS.USER_BUSY):a.name==n.CallNotFoundExceptionName?(this.logger.error("Call not found. One of the participant probably hungup.",a),b=m.RTC_ERRORS.CALL_NOT_FOUND,this._rtcSession._sessionReport.handshakingFailure=!0):(this.logger.error("Failed handshaking with signaling server",a),this._rtcSession._sessionReport.userBusyFailure=!1,this._rtcSession._sessionReport.handshakingFailure=!0,b=m.RTC_ERRORS.SIGNALLING_HANDSHAKE_FAILURE),this.transit(new E(this._rtcSession,b))}},{key:"name",get:function(){return"InviteAnswerState"}}]),b}(u),A=c.AcceptState=function(a){function b(a,c,d){g(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return f._sdp=c,f._candidates=d,f}return f(b,a),j(b,[{key:"_createSessionDescription",value:function(a){return new RTCSessionDescription(a)}},{key:"_createRemoteCandidate",value:function(a){return new RTCIceCandidate(a)}},{key:"onEnter",value:function(){var a=this,b=a._rtcSession;if(!a._sdp)return a.logger.error("Invalid remote SDP"),b._stopSession(),b._sessionReport.invalidRemoteSDPFailure=!0,void a.transit(new E(b,m.RTC_ERRORS.INVALID_REMOTE_SDP));if(!a._candidates||a._candidates.length<1)return a.logger.error("No remote ICE candidate"),b._stopSession(),b._sessionReport.noRemoteIceCandidateFailure=!0,void a.transit(new E(b,m.RTC_ERRORS.NO_REMOTE_ICE_CANDIDATE));b._sessionReport.invalidRemoteSDPFailure=!1,b._sessionReport.noRemoteIceCandidateFailure=!1;var c=b._pc.setRemoteDescription(a._createSessionDescription({type:"answer",sdp:a._sdp}));c.catch(function(b){a.logger.error("SetRemoteDescription failed",b)}),c.then(function(){var c=Promise.all(a._candidates.map(function(c){var d=a._createRemoteCandidate(c);return a.logger.info("Adding remote candidate",d),b._pc.addIceCandidate(d)}));return c.catch(function(b){a.logger.warn("Error adding remote candidate",b)}),c}).then(function(){b._sessionReport.setRemoteDescriptionFailure=!1,a._remoteDescriptionSet=!0,a._checkAndTransit()}).catch(function(){b._stopSession(),b._sessionReport.setRemoteDescriptionFailure=!0,a.transit(new E(b,m.RTC_ERRORS.SET_REMOTE_DESCRIPTION_FAILURE))})}},{key:"onSignalingHandshaked",value:function(){this._rtcSession._sessionReport.handshakingTimeMillis=Date.now()-this._rtcSession._signallingConnectTimestamp,this._signalingHandshaked=!0,this._checkAndTransit()}},{key:"_checkAndTransit",value:function(){this._signalingHandshaked&&this._remoteDescriptionSet?this.transit(new B(this._rtcSession)):this._signalingHandshaked?this.logger.log("Pending setting remote description"):this.logger.log("Pending handshaking")}},{key:"name",get:function(){return"AcceptState"}}]),b}(u),B=c.TalkingState=function(a){function b(){return g(this,b),e(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return f(b,a),j(b,[{key:"onEnter",value:function(){this._startTime=Date.now(),this._rtcSession._sessionReport.preTalkingTimeMillis=this._startTime-this._rtcSession._connectTimeStamp,this._rtcSession._onSessionConnected(this._rtcSession)}},{key:"onSignalingReconnected",value:function(){}},{key:"onRemoteHungup",value:function(){this._rtcSession._signalingChannel.hangup(),this.transit(new D(this._rtcSession))}},{key:"hangup",value:function(){this._rtcSession._signalingChannel.hangup(),this.transit(new D(this._rtcSession))}},{key:"onIceStateChange",value:function(a){"disconnected"==a.currentTarget.iceConnectionState&&(this.logger.info("Lost ICE connection"),this._rtcSession._sessionReport.iceConnectionsLost+=1)}},{key:"onExit",value:function(){this._rtcSession._sessionReport.talkingTimeMillis=Date.now()-this._startTime,this._rtcSession._detachMedia(),this._rtcSession._sessionReport.sessionEndTime=new Date,this._rtcSession._onSessionCompleted(this._rtcSession)}},{key:"name",get:function(){return"TalkingState"}}]),b}(u),C=c.CleanUpState=function(a){function b(){return g(this,b),e(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return f(b,a),j(b,[{key:"onEnter",value:function(){this._startTime=Date.now(),this._rtcSession._stopSession(),this._rtcSession._sessionReport.cleanupTimeMillis=Date.now()-this._startTime,this._rtcSession._onSessionDestroyed(this._rtcSession,this._rtcSession._sessionReport)}},{key:"hangup",value:function(){}},{key:"name",get:function(){return"CleanUpState"}}]),b}(u),D=c.DisconnectedState=function(a){function b(){return g(this,b),e(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return f(b,a),j(b,[{key:"name",get:function(){return"DisconnectedState"}}]),b}(C),E=c.FailedState=function(a){function b(a,c){g(this,b);var d=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return d._failureReason=c,d}return f(b,a),j(b,[{key:"onEnter",value:function(){this._rtcSession._sessionReport.sessionEndTime=new Date,this._rtcSession._onSessionFailed(this._rtcSession,this._failureReason),i(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"onEnter",this).call(this)}},{key:"name",get:function(){return"FailedState"}}]),b}(C),F=function(){function a(b,c,d,e,f){if(g(this,a),"string"!=typeof b||0===b.trim().length)throw new n.IllegalParameters("signalingUri required");if(!c)throw new n.IllegalParameters("iceServers required");if("object"!==(void 0===e?"undefined":h(e)))throw new n.IllegalParameters("logger required");this._callId=f||(0,r.default)(),this._sessionReport=new l.SessionReport,this._signalingUri=b,this._iceServers=c,this._contactToken=d,this._originalLogger=e,this._logger=(0,k.wrapLogger)(this._originalLogger,this._callId,"SESSION"),this._iceTimeoutMillis=m.DEFAULT_ICE_TIMEOUT_MS,this._gumTimeoutMillis=m.DEFAULT_GUM_TIMEOUT_MS,this._enableAudio=!0,this._enableVideo=!1,this._facingMode="user",this._userProvidedStream=!1,this._onGumError=this._onGumSuccess=this._onLocalStreamAdded=this._onSessionFailed=this._onSessionInitialized=this._onSignalingConnected=this._onIceCollectionComplete=this._onSignalingStarted=this._onSessionConnected=this._onRemoteStreamAdded=this._onSessionCompleted=this._onSessionDestroyed=function(){}}return j(a,[{key:"pauseLocalVideo",value:function(){if(this._localStream){var a=this._localStream.getVideoTracks()[0];a&&(a.enabled=!1)}}},{key:"resumeLocalVideo",value:function(){if(this._localStream){var a=this._localStream.getVideoTracks()[0];a&&(a.enabled=!0)}}},{key:"pauseRemoteVideo",value:function(){if(this._remoteVideoStream){var a=this._remoteVideoStream.getTracks()[1];a&&(a.enabled=!1)}}},{key:"resumeRemoteVideo",value:function(){if(this._remoteVideoStream){var a=this._remoteVideoStream.getTracks()[1];a&&(a.enabled=!0)}}},{key:"pauseLocalAudio",value:function(){if(this._localStream){var a=this._localStream.getAudioTracks()[0];a&&(a.enabled=!1)}}},{key:"resumeLocalAudio",value:function(){if(this._localStream){var a=this._localStream.getAudioTracks()[0];a&&(a.enabled=!0)}}},{key:"pauseRemoteAudio",value:function(){if(this._remoteAudioStream){var a=this._remoteAudioStream.getTracks()[0];a&&(a.enabled=!1)}}},{key:"resumeRemoteAudio",value:function(){if(this._remoteAudioStream){var a=this._remoteAudioStream.getTracks()[0];a&&(a.enabled=!0)}}},{key:"transit",value:function(a){try{this._logger.info((this._state?this._state.name:"null")+" => "+a.name),this._state&&this._state.onExit&&this._state.onExit()}finally{if(this._state=a,a.onEnter)try{a.onEnter()}catch(b){throw this._logger.warn(a.name+"#onEnter failed",b),b}}}},{key:"_createSignalingChannel",value:function(){var a=new p.default(this._callId,this._signalingUri,this._contactToken,this._originalLogger,this._signalingConnectTimeout);return a.onConnected=(0,k.hitch)(this,this._signalingConnected),a.onAnswered=(0,k.hitch)(this,this._signalingAnswered),a.onHandshaked=(0,k.hitch)(this,this._signalingHandshaked),a.onRemoteHungup=(0,k.hitch)(this,this._signalingRemoteHungup),a.onFailed=(0,k.hitch)(this,this._signalingFailed),a.onDisconnected=(0,k.hitch)(this,this._signalingDisconnected),this._signalingChannel=a,a}},{key:"_signalingConnected",value:function(){this._state.onSignalingConnected()}},{key:"_signalingAnswered",value:function(a,b){this._state.onSignalingAnswered(a,b)}},{key:"_signalingHandshaked",value:function(){this._state.onSignalingHandshaked()}},{key:"_signalingRemoteHungup",value:function(){this._state.onRemoteHungup()}},{key:"_signalingFailed",value:function(a){this._state.onSignalingFailed(a)}},{key:"_signalingDisconnected",value:function(){}},{key:"_createPeerConnection",value:function(a){return new RTCPeerConnection(a)}},{key:"connect",value:function(){var a=this,b=new Date;a._sessionReport.sessionStartTime=b,a._connectTimeStamp=b.getTime(),a._pc=a._createPeerConnection({iceServers:a._iceServers,iceTransportPolicy:"relay",rtcpMuxPolicy:"require",bundlePolicy:"balanced"},{optional:[{googDscp:!0}]}),a._pc.ontrack=(0,k.hitch)(a,a._ontrack),a._pc.onicecandidate=(0,k.hitch)(a,a._onIceCandidate),a._pc.oniceconnectionstatechange=(0,k.hitch)(a,a._onIceStateChange),a.transit(new v(a))}},{key:"accept",value:function(){throw new n.UnsupportedOperation("accept does not go through signaling channel at this moment")}},{key:"hangup",value:function(){this._state.hangup()}},{key:"getRemoteAudioStats",value:function(){var a=new Date;if(this._pc&&"stable"===this._pc.signalingState&&this._remoteAudioStream){var b=this._remoteAudioStream.getAudioTracks();return this._pc.getStats(b[0]).then(function(b){var c=(0,s.extractMediaStatsFromStats)(a,b,"audio_output");if(!c)throw new Error("Failed to extract MediaRtpStats from RTCStatsReport");return c})}return Promise.reject(new n.IllegalState)}},{key:"getUserAudioStats",value:function(){var a=new Date;if(this._pc&&"stable"===this._pc.signalingState&&this._localStream){var b=this._localStream.getAudioTracks();return this._pc.getStats(b[0]).then(function(b){var c=(0,s.extractMediaStatsFromStats)(a,b,"audio_input");if(!c)throw new Error("Failed to extract MediaRtpStats from RTCStatsReport");return c})}return Promise.reject(new n.IllegalState)}},{key:"getRemoteVideoStats",value:function(){var a=new Date;if(this._pc&&"stable"===this._pc.signalingState&&this._remoteVideoStream){var b=this._remoteVideoStream.getVideoTracks();return this._pc.getStats(b[0]).then(function(b){var c=(0,s.extractMediaStatsFromStats)(a,b,"video_output");if(!c)throw new Error("Failed to extract MediaRtpStats from RTCStatsReport");return c})}return Promise.reject(new n.IllegalState)}},{key:"getUserVideoStats",value:function(){var a=new Date;if(this._pc&&"stable"===this._pc.signalingState&&this._localStream){var b=this._localStream.getVideoTracks();return this._pc.getStats(b[0]).then(function(b){var c=(0,s.extractMediaStatsFromStats)(a,b,"video_input");if(!c)throw new Error("Failed to extract MediaRtpStats from RTCStatsReport");return c})}return Promise.reject(new n.IllegalState)}},{key:"_onIceCandidate",value:function(a){this._state.onIceCandidate(a)}},{key:"_onIceStateChange",value:function(a){this._state.onIceStateChange(a)}},{key:"_ontrack",value:function(a){a.streams.length>1&&this._logger.warn("Found more than 1 streams for "+a.track.kind+" track "+a.track.id+" : "+a.streams.map(function(a){return a.id}).join(",")),"video"===a.track.kind&&this._remoteVideoElement?(this._remoteVideoElement.srcObject=a.streams[0],this._remoteVideoStream=a.streams[0]):"audio"===a.track.kind&&this._remoteAudioElement&&(this._remoteAudioElement.srcObject=a.streams[0],this._remoteAudioStream=a.streams[0]),this._onRemoteStreamAdded(this,a.streams[0])}},{key:"_detachMedia",value:function(){this._remoteVideoElement&&(this._remoteVideoElement.srcObject=null),this._remoteAudioElement&&(this._remoteAudioElement.srcObject=null,this._remoteAudioStream=null)}},{key:"_stopSession",value:function(){try{this._localStream&&!this._userProvidedStream&&((0,k.closeStream)(this._localStream),this._localStream=null,this._userProvidedStream=!1)}finally{try{this._pc&&this._pc.close()}catch(a){}finally{this._pc=null}}}},{key:"_buildMediaConstraints",value:function(){var a=this,b={};if(a._enableAudio){var c={};void 0!==a._echoCancellation&&(c.echoCancellation=!!a._echoCancellation),Object.keys(c).length>0?b.audio=c:b.audio=!0}else b.audio=!1;if(a._enableVideo){var d={},e={},f={},g={};void 0!==a._idealVideoWidth&&(e.ideal=a._idealVideoWidth),void 0!==a._maxVideoWidth&&(e.max=a._maxVideoWidth),void 0!==a._minVideoWidth&&(e.min=a._minVideoWidth),void 0!==a._idealVideoHeight&&(f.ideal=a._idealVideoHeight),void 0!==a._maxVideoHeight&&(f.max=a._maxVideoHeight),void 0!==a._minVideoHeight&&(f.min=a._minVideoHeight),Object.keys(e).length>0&&Object.keys(f).length>0&&(d.width=e,d.height=f),void 0!==a._videoFrameRate&&(g.ideal=a._videoFrameRate),void 0!==a._minVideoFrameRate&&(g.min=a._minVideoFrameRate),void 0!==a._maxVideoFrameRate&&(g.max=a._maxVideoFrameRate),Object.keys(g).length>0&&(d.frameRate=g),"user"!==a._facingMode&&"environment"!==a._facingMode&&(a._facingMode="user"),d.facingMode=a._facingMode,Object.keys(d).length>0?b.video=d:b.video=!0}return b}},{key:"sessionReport",get:function(){return this._sessionReport}},{key:"callId",get:function(){return this._callId}},{key:"mediaStream",get:function(){return this._localStream},set:function(a){this._localStream=a,this._userProvidedStream=!0}},{key:"remoteVideoStream",get:function(){return this._remoteVideoStream}},{key:"onGumSuccess",set:function(a){this._onGumSuccess=a}},{key:"onGumError",set:function(a){this._onGumError=a}},{key:"onSessionFailed",set:function(a){this._onSessionFailed=a}},{key:"onLocalStreamAdded",set:function(a){this._onLocalStreamAdded=a}},{key:"onSessionInitialized",set:function(a){this._onSessionInitialized=a}},{key:"onSignalingConnected",set:function(a){this._onSignalingConnected=a}},{key:"onIceCollectionComplete",set:function(a){this._onIceCollectionComplete=a}},{key:"onSignalingStarted",set:function(a){this._onSignalingStarted=a}},{key:"onSessionConnected",set:function(a){this._onSessionConnected=a}},{key:"onRemoteStreamAdded",set:function(a){this._onRemoteStreamAdded=a}},{key:"onSessionCompleted",set:function(a){this._onSessionCompleted=a}},{key:"onSessionDestroyed",set:function(a){this._onSessionDestroyed=a}},{key:"enableAudio",set:function(a){this._enableAudio=a}},{key:"echoCancellation",set:function(a){this._echoCancellation=a}},{key:"enableVideo",set:function(a){this._enableVideo=a}},{key:"maxVideoFrameRate",set:function(a){this._maxVideoFrameRate=a}},{key:"minVideoFrameRate",set:function(a){this._minVideoFrameRate=a}},{key:"videoFrameRate",set:function(a){this._videoFrameRate=a}},{key:"maxVideoWidth",set:function(a){this._maxVideoWidth=a}},{key:"minVideoWidth",set:function(a){this._minVideoWidth=a}},{key:"idealVideoWidth",set:function(a){this._idealVideoWidth=a}},{key:"maxVideoHeight",set:function(a){this._maxVideoHeight=a}},{key:"minVideoHeight",set:function(a){this._minVideoHeight=a}},{key:"idealVideoHeight",set:function(a){this._idealVideoHeight=a}},{key:"facingMode",set:function(a){this._facingMode=a}},{key:"remoteAudioElement",set:function(a){this._remoteAudioElement=a}},{key:"remoteVideoElement",set:function(a){this._remoteVideoElement=a}},{key:"signalingConnectTimeout",set:function(a){this._signalingConnectTimeout=a}},{key:"iceTimeoutMillis",set:function(a){this._iceTimeoutMillis=a}},{key:"gumTimeoutMillis",set:function(a){this._gumTimeoutMillis=a}},{key:"forceAudioCodec",set:function(a){this._forceAudioCodec=a}},{key:"forceVideoCodec",set:function(a){this._forceVideoCodec=a}},{key:"enableOpusDtx",set:function(a){this._enableOpusDtx=a}}]),a}();c.default=F},{"./exceptions":15,"./rtc_const":16,"./rtp-stats":18,"./session_report":19,"./signaling":20,"./utils":21,sdp:1,"uuid/v4":4}],18:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b,c){var d=null;if(!b)return d;var e=Object.keys(b);if(e)for(var f=0;f<e.length;f++){var h=b[e[f]];if(h){var i=0,j=null,k=null,l=null;if("ssrc"===h.type){if(void 0!==h.packetsSent&&"audio"==h.mediaType&&"audio_input"===c){void 0!==h.audioInputLevel&&(j=h.audioInputLevel),void 0!==h.packetsLost&&h.packetsLost>0&&(i=h.packetsLost),void 0!==h.googRtt&&(k=h.googRtt),d=new g(a,i,h.packetsSent,j,k,null,h.bytesSent);break}if(void 0!==h.packetsReceived&&"audio"==h.mediaType&&"audio_output"===c){void 0!==h.audioOutputLevel&&(j=h.audioOutputLevel),void 0!==h.packetsLost&&h.packetsLost>0&&(i=h.packetsLost),void 0!==h.googJitterBufferMs&&(l=h.googJitterBufferMs),d=new g(a,i,h.packetsReceived,j,null,l,null,h.bytesReceived);break}if(void 0!==h.packetsSent&&"video"==h.mediaType&&"video_input"===c){void 0!==h.packetsLost&&h.packetsLost>0&&(i=h.packetsLost),void 0!==h.googRtt&&(k=h.googRtt);var m=null;void 0!==h.googFrameRateSent&&(m=h.googFrameRateSent),d=new g(a,i,h.packetsSent,null,k,null,h.bytesSent,null,h.framesEncoded,null,m,null);break}if(void 0!==h.packetsReceived&&"video"==h.mediaType&&"video_output"===c){void 0!==h.packetsLost&&h.packetsLost>0&&(i=h.packetsLost),void 0!==h.googJitterBufferMs&&(l=h.googJitterBufferMs);var n=null;void 0!==h.googFrameRateReceived&&(n=h.googFrameRateReceived),d=new g(a,i,h.packetsReceived,null,null,l,null,h.bytesReceived,null,h.framesDecoded,null,n);break}}else if("inboundrtp"===h.type&&void 0!==h.packetsLost&&void 0!==h.packetsReceived){void 0!==h.audioInputLevel&&(j=h.audioInputLevel),h.packetsLost>0&&(i=h.packetsLost),d=new g(a,i,h.packetsReceived,j);break}}}return d}Object.defineProperty(c,"__esModule",{value:!0});var f=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();c.extractMediaStatsFromStats=e;var g=function(){function a(b,c,e,f,g,h,i,j,k,l,m,n){d(this,a),this._timestamp=b,this._packetsLost=c,this._packetsCount=e,this._audioLevel=f,this._rttMilliseconds=g,this._jbMilliseconds=h,this._bytesSent=i,this._bytesReceived=j,this._framesEncoded=k,this._framesDecoded=l,this._frameRateSent=m,this._frameRateReceived=n}return f(a,[{key:"packetsCount",get:function(){return this._packetsCount}},{key:"packetsLost",get:function(){return this._packetsLost}},{key:"packetLossPercentage",get:function(){return this._packetsCount>0?this._packetsLost/this._packetsCount:0}},{key:"audioLevel",get:function(){return this._audioLevel}},{key:"timestamp",get:function(){return this._timestamp}},{key:"rttMilliseconds",get:function(){return this._rttMilliseconds}},{key:"jbMilliseconds",get:function(){return this._jbMilliseconds}},{key:"bytesSent",get:function(){return this._bytesSent}},{key:"bytesReceived",get:function(){return this._bytesReceived}},{key:"framesEncoded",
get:function(){return this._framesEncoded}},{key:"framesDecoded",get:function(){return this._framesDecoded}},{key:"frameRateSent",get:function(){return this._frameRateSent}},{key:"frameRateReceived",get:function(){return this._frameRateReceived}}]),a}()},{}],19:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(c,"__esModule",{value:!0});var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();c.SessionReport=function(){function a(){d(this,a),this._sessionStartTime=null,this._sessionEndTime=null,this._gumTimeMillis=null,this._initializationTimeMillis=null,this._iceCollectionTimeMillis=null,this._signallingConnectTimeMillis=null,this._handshakingTimeMillis=null,this._preTalkingTimeMillis=null,this._talkingTimeMillis=null,this._iceConnectionsLost=0,this._cleanupTimeMillis=null,this._iceCollectionFailure=null,this._signallingConnectionFailure=null,this._handshakingFailure=null,this._gumOtherFailure=null,this._gumTimeoutFailure=null,this._createOfferFailure=null,this._setLocalDescriptionFailure=null,this._userBusyFailure=null,this._invalidRemoteSDPFailure=null,this._noRemoteIceCandidateFailure=null,this._setRemoteDescriptionFailure=null,this._streamStats=[]}return e(a,[{key:"sessionStartTime",get:function(){return this._sessionStartTime},set:function(a){this._sessionStartTime=a}},{key:"sessionEndTime",get:function(){return this._sessionEndTime},set:function(a){this._sessionEndTime=a}},{key:"gumTimeMillis",get:function(){return this._gumTimeMillis},set:function(a){this._gumTimeMillis=a}},{key:"initializationTimeMillis",get:function(){return this._initializationTimeMillis},set:function(a){this._initializationTimeMillis=a}},{key:"iceCollectionTimeMillis",get:function(){return this._iceCollectionTimeMillis},set:function(a){this._iceCollectionTimeMillis=a}},{key:"signallingConnectTimeMillis",get:function(){return this._signallingConnectTimeMillis},set:function(a){this._signallingConnectTimeMillis=a}},{key:"preTalkingTimeMillis",get:function(){return this._preTalkingTimeMillis},set:function(a){this._preTalkingTimeMillis=a}},{key:"handshakingTimeMillis",get:function(){return this._handshakingTimeMillis},set:function(a){this._handshakingTimeMillis=a}},{key:"talkingTimeMillis",get:function(){return this._talkingTimeMillis},set:function(a){this._talkingTimeMillis=a}},{key:"iceConnectionsLost",get:function(){return this._iceConnectionsLost},set:function(a){this._iceConnectionsLost=a}},{key:"cleanupTimeMillis",get:function(){return this._cleanupTimeMillis},set:function(a){this._cleanupTimeMillis=a}},{key:"iceCollectionFailure",get:function(){return this._iceCollectionFailure},set:function(a){this._iceCollectionFailure=a}},{key:"signallingConnectionFailure",get:function(){return this._signallingConnectionFailure},set:function(a){this._signallingConnectionFailure=a}},{key:"handshakingFailure",get:function(){return this._handshakingFailure},set:function(a){this._handshakingFailure=a}},{key:"gumTimeoutFailure",get:function(){return this._gumTimeoutFailure},set:function(a){this._gumTimeoutFailure=a}},{key:"gumOtherFailure",get:function(){return this._gumOtherFailure},set:function(a){this._gumOtherFailure=a}},{key:"createOfferFailure",get:function(){return this._createOfferFailure},set:function(a){this._createOfferFailure=a}},{key:"setLocalDescriptionFailure",get:function(){return this._setLocalDescriptionFailure},set:function(a){this._setLocalDescriptionFailure=a}},{key:"userBusyFailure",get:function(){return this._userBusyFailure},set:function(a){this._userBusyFailure=a}},{key:"invalidRemoteSDPFailure",get:function(){return this._invalidRemoteSDPFailure},set:function(a){this._invalidRemoteSDPFailure=a}},{key:"setRemoteDescriptionFailure",get:function(){return this._setRemoteDescriptionFailure},set:function(a){this._setRemoteDescriptionFailure=a}},{key:"noRemoteIceCandidateFailure",get:function(){return this._noRemoteIceCandidateFailure},set:function(a){this._noRemoteIceCandidateFailure=a}},{key:"streamStats",get:function(){return this._streamStats},set:function(a){this._streamStats=a}}]),a}()},{}],20:[function(a,b,c){"use strict";function d(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function e(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function f(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(c,"__esModule",{value:!0}),c.FailedState=c.DisconnectedState=c.PendingLocalHangupState=c.PendingRemoteHangupState=c.PendingReconnectState=c.TalkingState=c.PendingAcceptAckState=c.PendingAcceptState=c.PendingAnswerState=c.PendingInviteState=c.PendingConnectState=c.FailOnTimeoutState=c.SignalingState=void 0;var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=a("./utils"),i=a("./rtc_const"),j=a("./exceptions"),k=1,l=c.SignalingState=function(){function a(b){f(this,a),this._signaling=b,this._createTime=(new Date).getTime()}return g(a,[{key:"setStateTimeout",value:function(a){setTimeout((0,h.hitch)(this,this._onTimeoutChecked),a)}},{key:"onEnter",value:function(){}},{key:"_onTimeoutChecked",value:function(){this.isCurrentState&&this.onTimeout()}},{key:"onTimeout",value:function(){throw new j.UnsupportedOperation}},{key:"transit",value:function(a){this._signaling.transit(a)}},{key:"onExit",value:function(){}},{key:"onOpen",value:function(){throw new j.UnsupportedOperation("onOpen not supported by "+this.name)}},{key:"onError",value:function(){this.channelDown()}},{key:"onClose",value:function(){this.channelDown()}},{key:"channelDown",value:function(){throw new j.UnsupportedOperation("channelDown not supported by "+this.name)}},{key:"onRpcMsg",value:function(a){throw new j.UnsupportedOperation("onRpcMsg not supported by "+this.name)}},{key:"invite",value:function(a,b){throw new j.UnsupportedOperation("invite not supported by "+this.name)}},{key:"accept",value:function(){throw new j.UnsupportedOperation("accept not supported by "+this.name)}},{key:"hangup",value:function(){throw new j.UnsupportedOperation("hangup not supported by "+this.name)}},{key:"isCurrentState",get:function(){return this===this._signaling.state}},{key:"name",get:function(){return"SignalingState"}},{key:"logger",get:function(){return this._signaling._logger}}]),a}(),m=c.FailOnTimeoutState=function(a){function b(a,c){f(this,b);var e=d(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return e._timeoutMs=c,e}return e(b,a),g(b,[{key:"onEnter",value:function(){this.setStateTimeout(this._stateTimeoutMs)}},{key:"onTimeout",value:function(){this.transit(new x(this._signaling,new j.Timeout))}},{key:"name",get:function(){return"FailOnTimeoutState"}}]),b}(l),n=c.PendingConnectState=function(a){function b(a,c,e,g){f(this,b);var h=d(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a,c));return h._initialStartTime=e||(new Date).getTime(),h._retries=g||0,h}return e(b,a),g(b,[{key:"onOpen",value:function(){this.transit(new o(this._signaling))}},{key:"channelDown",value:function(){var a=(new Date).getTime(),c=this._initialStartTime+this._timeoutMs-a;c>0&&++this._retries<3?(this._signaling._connect(),this.transit(new b(this._signaling,c,this._initialStartTime,this._retries))):this.transit(new x(this._signaling,new Error("channelDown")))}},{key:"name",get:function(){return"PendingConnectState"}}]),b}(m),o=c.PendingInviteState=function(a){function b(){return f(this,b),d(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return e(b,a),g(b,[{key:"onEnter",value:function(){var a=this;new Promise(function(b){a._signaling._connectedHandler(),b()})}},{key:"invite",value:function(a,b){var c=this,d=k++,e={sdp:a,candidates:b};c.logger.log("Sending SDP",a),c._signaling._wss.send(JSON.stringify({jsonrpc:"2.0",method:"invite",params:e,id:d})),c.transit(new p(c._signaling,d))}},{key:"channelDown",value:function(){this.transit(new x(this._signaling))}},{key:"name",get:function(){return"PendingInviteState"}}]),b}(l),p=c.PendingAnswerState=function(a){function b(a,c){f(this,b);var e=d(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a,i.MAX_INVITE_DELAY_MS));return e._inviteId=c,e}return e(b,a),g(b,[{key:"onRpcMsg",value:function(a){var b=this;a.id===this._inviteId&&(a.error||!a.result?this.transit(new x(this._signaling,b.translateInviteError(a))):(new Promise(function(c){b.logger.log("Received SDP",a.result.sdp),b._signaling._answeredHandler(a.result.sdp,a.result.candidates),c()}),this.transit(new q(this._signaling,this._signaling._autoAnswer))))}},{key:"translateInviteError",value:function(a){return a.error&&486==a.error.code?new j.BusyException(a.error.message):a.error&&404==a.error.code?new j.CallNotFoundException(a.error.message):new j.UnknownSignalingError}},{key:"name",get:function(){return"PendingAnswerState"}}]),b}(m),q=c.PendingAcceptState=function(a){function b(a,c){f(this,b);var e=d(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return e._autoAnswer=c,e}return e(b,a),g(b,[{key:"onEnter",value:function(){this._autoAnswer&&this.accept()}},{key:"accept",value:function(){var a=k++;this._signaling._wss.send(JSON.stringify({jsonrpc:"2.0",method:"accept",params:{},id:a})),this.transit(new r(this._signaling,a))}},{key:"channelDown",value:function(){this.transit(new x(this._signaling))}},{key:"name",get:function(){return"PendingAcceptState"}}]),b}(l),r=c.PendingAcceptAckState=function(a){function b(a,c){f(this,b);var e=d(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a,i.MAX_ACCEPT_BYE_DELAY_MS));return e._acceptId=c,e}return e(b,a),g(b,[{key:"onRpcMsg",value:function(a){a.id===this._acceptId&&(a.error?this.transit(new x(this._signaling)):(this._signaling._clientToken=a.result.clientToken,this.transit(new s(this._signaling))))}},{key:"name",get:function(){return"PendingAcceptAckState"}}]),b}(m),s=c.TalkingState=function(a){function b(){return f(this,b),d(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return e(b,a),g(b,[{key:"onEnter",value:function(){var a=this;new Promise(function(b){a._signaling._handshakedHandler(),b()})}},{key:"hangup",value:function(){var a=k++;this._signaling._wss.send(JSON.stringify({jsonrpc:"2.0",method:"bye",params:{},id:a})),this.transit(new u(this._signaling,a))}},{key:"onRpcMsg",value:function(a){"bye"===a.method?this.transit(new v(this._signaling,a.id)):"renewClientToken"===a.method&&(this._signaling._clientToken=a.params.clientToken)}},{key:"channelDown",value:function(){this._signaling._reconnect(),this._signaling.transit(new t(this._signaling))}},{key:"name",get:function(){return"TalkingState"}}]),b}(l),t=c.PendingReconnectState=function(a){function b(a){return f(this,b),d(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a,i.DEFAULT_CONNECT_TIMEOUT_MS))}return e(b,a),g(b,[{key:"onOpen",value:function(){this.transit(new s(this._signaling))}},{key:"channelDown",value:function(){this.transit(new x(this._signaling))}},{key:"name",get:function(){return"PendingReconnectState"}}]),b}(m),u=c.PendingRemoteHangupState=function(a){function b(a,c){f(this,b);var e=d(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a,i.MAX_ACCEPT_BYE_DELAY_MS));return e._byeId=c,e}return e(b,a),g(b,[{key:"onRpcMsg",value:function(a){a.id===this._byeId&&this.transit(new w(this._signaling))}},{key:"name",get:function(){return"PendingRemoteHangupState"}}]),b}(m),v=c.PendingLocalHangupState=function(a){function b(a,c){f(this,b);var e=d(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return e._byeId=c,e}return e(b,a),g(b,[{key:"onEnter",value:function(){var a=this;new Promise(function(b){a._signaling._remoteHungupHandler(),b()})}},{key:"hangup",value:function(){var a=this;a._signaling._wss.send(JSON.stringify({jsonrpc:"2.0",result:{},id:a._byeId})),a.transit(new w(a._signaling))}},{key:"channelDown",value:function(){this.transit(new w(this._signaling))}},{key:"name",get:function(){return"PendingLocalHangupState"}}]),b}(l),w=c.DisconnectedState=function(a){function b(){return f(this,b),d(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return e(b,a),g(b,[{key:"onEnter",value:function(){var a=this;new Promise(function(b){a._signaling._disconnectedHandler(),b()}),this._signaling._wss.close()}},{key:"channelDown",value:function(){}},{key:"name",get:function(){return"DisconnectedState"}}]),b}(l),x=c.FailedState=function(a){function b(a,c){f(this,b);var e=d(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return e._exception=c,e}return e(b,a),g(b,[{key:"onEnter",value:function(){var a=this;new Promise(function(b){a._signaling._failedHandler(a._exception),b()}),this._signaling._wss.close()}},{key:"channelDown",value:function(){}},{key:"name",get:function(){return"FailedState"}},{key:"exception",get:function(){return this._exception}}]),b}(l),y=function(){function a(b,c,d,e,g){f(this,a),this._callId=b,this._connectTimeoutMs=g||i.DEFAULT_CONNECT_TIMEOUT_MS,this._autoAnswer=!0,this._signalingUri=c,this._contactToken=d,this._logger=(0,h.wrapLogger)(e,b,"SIGNALING"),this._connectedHandler=this._answeredHandler=this._handshakedHandler=this._reconnectedHandler=this._remoteHungupHandler=this._disconnectedHandler=this._failedHandler=function(){}}return g(a,[{key:"connect",value:function(){this._connect(),this.transit(new n(this,this._connectTimeoutMs))}},{key:"_connect",value:function(){this._wss=this._connectWebSocket(this._buildInviteUri())}},{key:"transit",value:function(a){try{this._logger.info((this._state?this._state.name:"null")+" => "+a.name),this.state&&this.state.onExit&&this.state.onExit()}finally{this._state=a,this._state.onEnter&&this._state.onEnter()}}},{key:"_connectWebSocket",value:function(a){var b=new WebSocket(a);return b.onopen=(0,h.hitch)(this,this._onOpen),b.onmessage=(0,h.hitch)(this,this._onMessage),b.onerror=(0,h.hitch)(this,this._onError),b.onclose=(0,h.hitch)(this,this._onClose),b}},{key:"_buildInviteUri",value:function(){return this._contactToken?this._buildUriBase()+"&contactCtx="+encodeURIComponent(this._contactToken):this._buildUriBase()}},{key:"_buildReconnectUri",value:function(){return this._buildUriBase()+"&clientToken="+encodeURIComponent(this._clientToken)}},{key:"_buildUriBase",value:function(){var a="?";return this._signalingUri.indexOf(a)>-1&&(a="&"),this._signalingUri+a+"callId="+encodeURIComponent(this._callId)}},{key:"_onMessage",value:function(a){this.state.onRpcMsg(JSON.parse(a.data))}},{key:"_onOpen",value:function(a){this.state.onOpen(a)}},{key:"_onError",value:function(a){this.state.onError(a)}},{key:"_onClose",value:function(a){this._logger.log("WebSocket onclose code="+a.code+", reason="+a.reason),this.state.onClose(a)}},{key:"_reconnect",value:function(){this._wss=this._connectWebSocket(this._buildReconnectUri())}},{key:"invite",value:function(a,b){this.state.invite(a,b)}},{key:"accept",value:function(){this.state.accept()}},{key:"hangup",value:function(){this.state.hangup()}},{key:"callId",get:function(){return this._callId}},{key:"onConnected",set:function(a){this._connectedHandler=a}},{key:"onAnswered",set:function(a){this._answeredHandler=a}},{key:"onHandshaked",set:function(a){this._handshakedHandler=a}},{key:"onReconnected",set:function(a){this._reconnectedHandler=a}},{key:"onRemoteHungup",set:function(a){this._remoteHungupHandler=a}},{key:"onDisconnected",set:function(a){this._disconnectedHandler=a}},{key:"onFailed",set:function(a){this._failedHandler=a}},{key:"state",get:function(){return this._state}}]),a}();c.default=y},{"./exceptions":15,"./rtc_const":16,"./utils":21}],21:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(){var a=Array.prototype.slice.call(arguments),b=a.shift(),c=a.shift();if(!b)throw new j.IllegalParameters("utils.hitch(): scope is required!");if(!c)throw new j.IllegalParameters("utils.hitch(): method is required!");if("function"!=typeof c)throw new j.IllegalParameters("utils.hitch(): method is not a function!");return function(){var d=Array.prototype.slice.call(arguments);return c.apply(b,a.concat(d))}}function f(a,b,c){var d={};return l.forEach(function(f){if(!a[f])throw new Error("Logging method "+f+" required");d[f]=e(a,a[f],b,c)}),d}function g(a){if(a)for(var b=a.getTracks(),c=0;c<b.length;c++){var d=b[c];try{d.stop()}catch(a){}}}function h(a,b){for(var c=(0,k.splitSections)(a),d=1;d<c.length;d++){var e=(0,k.getKind)(c[d]),f=(0,k.parseRtpParameters)(c[d]),g=f.codecs.reduce(function(a,b){return a[""+b.payloadType]=b,a},{});c[d]=(0,k.splitLines)(c[d]).map(function(a){if(a.startsWith("m=")){if(b.forceCodec[e]){var c=Object.keys(g).filter(function(a){return!b._shouldDeleteCodec(e,g[a].name)});return a.substring(0,a.indexOf("UDP/TLS/RTP/SAVPF ")+"UDP/TLS/RTP/SAVPF ".length)+c.join(" ")}return a}if(a.startsWith("a=rtpmap:")){var d=(0,k.parseRtpMap)(a),f=g[d.payloadType];return b._shouldDeleteCodec(e,f.name)?null:"OPUS"===f.name.toUpperCase()?(f.parameters.usedtx=b.enableOpusDtx?1:0,(a+"\r\n"+(0,k.writeFmtp)(f)).trim()):a}if(a.startsWith("a=fmtp:")){var h=a.substring("a=fmtp:".length,a.indexOf(" ")),f=g[h];return b._shouldDeleteCodec(e,f.name)?null:"OPUS"===f.name.toUpperCase()?null:a}if(a.startsWith("a=rtcp-fb:")){var h=a.substring(a.indexOf(":")+1,a.indexOf(" ")),f=g[h];return b._shouldDeleteCodec(e,f.name)?null:a}return a}).filter(function(a){return null!==a}).join("\r\n")}return{sdp:c.map(function(a){return a.trim()}).join("\r\n")+"\r\n",mLines:c.length-1}}Object.defineProperty(c,"__esModule",{value:!0}),c.SdpOptions=void 0;var i=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();c.hitch=e,c.wrapLogger=f,c.closeStream=g,c.transformSdp=h;var j=a("./exceptions"),k=a("sdp"),l=["log","info","warn","error"];c.SdpOptions=function(){function a(){d(this,a),this._forceCodec={}}return i(a,[{key:"_shouldDeleteCodec",value:function(a,b){var c=b.toUpperCase();return this._forceCodec[a]&&c!==this._forceCodec[a].toUpperCase()&&"TELEPHONE-EVENT"!==c}},{key:"enableOpusDtx",get:function(){return this._enableOpusDtx},set:function(a){this._enableOpusDtx=a}},{key:"forceCodec",get:function(){return this._forceCodec}}]),a}()},{"./exceptions":15,sdp:1}]},{},[14]);